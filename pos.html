<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHARMACY POS - MAXIMUM FEATURES (AUTO PRINT DISABLED / SUPPLIER OPTIONAL)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        body { 
            background-color: #f0f2f5; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        header { 
            background-color: #343a40; 
        } 

        .tabs .btn { 
            background-color: #495057; 
            border: none; 
            color: white; 
            transition: background-color 0.2s; 
        }
        .tabs .btn:hover { 
            background-color: #5a6268; 
        }
        .tabs .btn.active { 
            background-color: #007bff; 
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); 
        }

        .screen { 
            display: none; 
            background-color: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin-top: 15px; 
            min-height: 80vh; 
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05); 
        }
        .screen.active { 
            display: block; 
        }

        .dashboard-card { transition: transform 0.2s; cursor: pointer; }
        .dashboard-card:hover { transform: translateY(-3px); }

        .product-tile { cursor: pointer; border: 1px solid #ccc; transition: all 0.2s; }
        .product-tile:hover { background-color: #e6f7ff; border-color: #007bff; }
        .price-tag { font-size: 1.2rem; font-weight: bold; color: #28a745; }

        .low-stock-row { background-color: #fff3cd; }
        .expired-row { background-color: #f8d7da; color: #721c24; }
        .soon-to-expire-row { background-color: #ffe0b2; } 
        .reorder-needed { background-color: #dc3545!important; color: white!important; font-weight: bold; } /* Enhanced visibility */

        /* Print Invoice Styling */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                position: absolute; left: 0; top: 0; width: 100%; padding: 10px;
                font-family: monospace; font-size: 10pt;
            }
            .no-print { display: none; }
            .invoice-line { display: flex; justify-content: space-between; }
            .invoice-footer { margin-top: 15px; border-top: 1px dashed black; padding-top: 5px; text-align: center; }
        }
    </style>
</head>
<body>

    <header class="text-white p-3 shadow-sm no-print">
        <h1 class="h3 mb-0">Pharmacy Point of Sale (Auto Print Disabled)</h1>
        <div class="tabs mt-2">
            <button class="btn btn-primary active" data-target="dashboard-screen"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
            <button class="btn btn-primary" data-target="pos-screen"><i class="fas fa-cash-register"></i> Sales</button>
            <button class="btn btn-primary" data-target="inventory-screen"><i class="fas fa-boxes"></i> Inventory</button>
            <button class="btn btn-primary" data-target="purchase-screen"><i class="fas fa-truck"></i> Purchases</button>
            <button class="btn btn-primary" data-target="reports-screen"><i class="fas fa-chart-line"></i> Reports</button>
            <button class="btn btn-primary" data-target="expense-screen"><i class="fas fa-wallet"></i> Expenses</button>
        </div>
    </header>

    <main class="container-fluid p-3">
        
        <section id="dashboard-screen" class="screen active">
            <h2 class="text-dark mb-4"><i class="fas fa-chart-pie"></i> Business Overview</h2>
            
            <div class="row mb-4 align-items-center">
                <div class="col-md-3">
                    <label for="dashboard-filter" class="form-label fw-bold">Select Period:</label>
                    <select id="dashboard-filter" class="form-select" onchange="renderDashboard()">
                        <option value="day">Today</option>
                        <option value="week">Last 7 Days</option>
                        <option value="month">This Month</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="col-md-9 text-end">
                    <button class="btn btn-info" onclick="showScreen('purchase-screen')">New Purchase Order</button>
                    <button class="btn btn-danger" onclick="showScreen('expense-screen')">Record New Expense</button>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white dashboard-card shadow">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-hand-holding-usd"></i> Total Revenue (<span id="dashboard-period">Today</span>)</h5>
                            <h1 class="display-5 fw-bold" id="dashboard-sales">0.00 PKR</h1>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white dashboard-card shadow">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-dollar-sign"></i> Net Profit (<span id="dashboard-period-2">Today</span>)</h5>
                            <h1 class="display-5 fw-bold" id="dashboard-profit">0.00 PKR</h1>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white dashboard-card shadow" data-target="inventory-screen">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-truck-loading"></i> Re-Order Needed</h5>
                            <h1 class="display-5 fw-bold" id="dashboard-reorder-needed">0</h1>
                        </div>
                    </div>
                </div>
                 <div class="col-md-3">
                    <div class="card bg-info text-white dashboard-card shadow" data-target="expense-screen">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-minus-circle"></i> Total Expenses (<span id="dashboard-period-3">Today</span>)</h5>
                            <h1 class="display-5 fw-bold" id="dashboard-expenses">0.00 PKR</h1>
                        </div>
                    </div>
                </div>
            </div>
            
            <h4 class="mt-5 text-secondary">Recent Sales (Today)</h4>
            <div id="dashboard-recent-sales-table" class="table-responsive">
                </div>
        </section>
        
        <section id="pos-screen" class="screen row">
            
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h5 text-primary">Products</h2>
                    <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#heldSalesModal" onclick="renderHeldSalesList()">
                        <i class="fas fa-pause"></i> Held Sales (<span id="held-count">0</span>)
                    </button>
                </div>
                
                <input type="text" id="product-search" class="form-control mb-3" placeholder="Search product name or batch..." oninput="searchProduct()">
                
                <div id="product-tiles-container" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
                    </div>
            </div>

            <div class="col-lg-4 border-start ps-4">
                <h2 class="h5 mb-3 text-success" id="cart-title">Cart</h2>
                
                <div class="table-responsive mb-3" style="max-height: 40vh; overflow-y: auto;">
                    <table class="table table-sm" id="cart-table">
                        <thead>
                            <tr class="table-dark"><th>Item</th><th>Qty</th><th>Total</th><th>X</th></tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>

                <div class="summary-area p-2 border-top">
                    
                    <h5 class="mt-2 text-info">Customer Info</h5>
                    <input type="text" id="customer-name" class="form-control form-control-sm mb-2" placeholder="Customer Name (Optional)">
                    <input type="text" id="customer-phone" class="form-control form-control-sm mb-3" placeholder="Phone (Optional)">
                    
                    <div class="input-group input-group-sm mb-3">
                        <span class="input-group-text">Tax/GST (%)</span>
                        <input type="number" id="tax-percent" class="form-control" value="0" min="0" oninput="calculateTotal()">
                    </div>

                    <p class="d-flex justify-content-between">Subtotal: <span id="subtotal" class="fw-bold">0.00</span> PKR</p>
                    <p class="d-flex justify-content-between text-danger">Tax/GST: <span id="tax-amount" class="fw-bold">0.00</span> PKR</p>

                    <div class="input-group input-group-sm mb-3">
                        <span class="input-group-text">Discount %</span>
                        <input type="number" id="discount" class="form-control" value="0" min="0" oninput="calculateTotal()">
                    </div>
                    
                    <h4 class="d-flex justify-content-between text-danger">Total: <span id="grand-total" class="fw-bold">0.00</span> PKR</h4>
                    
                    <select id="payment-method" class="form-select form-select-sm mb-3">
                        <option value="Cash">Cash</option>
                        <option value="Card">Card</option>
                        <option value="MobilePay">Mobile Pay (e.g., EasyPaisa)</option>
                    </select>

                    <button onclick="finalizeSale()" class="btn btn-success w-100 mt-1 p-2"><i class="fas fa-check-circle"></i> Complete Sale</button>
                    <div class="row mt-2 g-1">
                        <div class="col-6"><button onclick="holdSale()" class="btn btn-warning w-100"><i class="fas fa-pause"></i> Hold</button></div>
                        <div class="col-6"><button onclick="showReturnModal()" class="btn btn-danger w-100"><i class="fas fa-undo-alt"></i> Refund</button></div>
                    </div>
                    <div id="sale-message" class="mt-2 text-center"></div>

                    <button id="print-last-invoice-btn" onclick="printLastInvoice()" class="btn btn-info w-100 mt-2 p-2" style="display:none;">
                        <i class="fas fa-print"></i> Print Last Invoice
                    </button>
                </div>
            </div>
        </section>

        <section id="inventory-screen" class="screen">
            <h2 class="text-secondary"><i class="fas fa-warehouse"></i> Inventory Management</h2>
            
            <div class="d-flex justify-content-end mb-3">
                <input type="file" id="csv-file-input" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
                <button class="btn btn-info" onclick="document.getElementById('csv-file-input').click();">
                    <i class="fas fa-file-csv"></i> Import CSV Stock
                </button>
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-light">Add/Update Stock</div>
                <div class="card-body">
                    <form id="add-product-form" class="row g-3">
                        <div class="col-md-2"><input type="text" id="p-name" class="form-control" placeholder="Name" required></div>
                        <div class="col-md-2"><input type="text" id="p-batch" class="form-control" placeholder="Batch No." required></div>
                        <div class="col-md-2"><input type="date" id="p-expiry" class="form-control" required title="Expiry Date"></div>
                        <div class="col-md-1"><input type="text" id="p-type" class="form-control" placeholder="Type (Tab/Syp)" required></div> 
                        <div class="col-md-1"><input type="number" id="p-price" class="form-control" placeholder="Sell Price" required min="1"></div>
                        <div class="col-md-1"><input type="number" id="p-cost" class="form-control" placeholder="Cost Price" required min="1"></div>
                        <div class="col-md-1"><input type="number" id="p-qty" class="form-control" placeholder="Qty" required min="1"></div>
                        <div class="col-md-1"><input type="number" id="p-reorder" class="form-control" placeholder="Re-Order Level" required min="1"></div>
                        <div class="col-md-1">
                            <select id="p-supplier" class="form-select"> 
                                <option value="">Supplier (Optional)</option>
                                </select>
                        </div>
                        <div class="col-md-1"><button type="submit" class="btn btn-warning w-100"><i class="fas fa-upload"></i> Save</button></div>
                    </form>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="inventory-table">
                    <thead class="table-primary">
                        <tr>
                            <th>ID</th><th>Name</th><th>Batch No.</th><th>Expiry Date</th><th>Type</th><th>Sell Price</th><th>Cost Price (Avg)</th><th>Re-Order Level</th><th>Stock</th><th>Supplier</th><th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <h4 class="mt-5 text-secondary">Supplier Management</h4>
             <form id="add-supplier-form" class="row g-2 mb-3">
                <div class="col-md-3"><input type="text" id="s-name" class="form-control" placeholder="Supplier Name" required></div>
                <div class="col-md-3"><input type="text" id="s-phone" class="form-control" placeholder="Phone/Contact"></div>
                <div class="col-md-2"><button type="submit" class="btn btn-primary w-100"><i class="fas fa-plus"></i> Add Supplier</button></div>
            </form>
            <div id="supplier-list-container"></div>
        </section>
        
        <section id="purchase-screen" class="screen">
            <h2 class="text-secondary"><i class="fas fa-shopping-basket"></i> Purchase Management (New Stock In)</h2>
            <div class="card mb-4">
                <div class="card-header bg-light">Record New Purchase Invoice</div>
                <div class="card-body">
                    <form id="add-purchase-form" class="row g-3">
                        <div class="col-md-3">
                            <select id="purchase-supplier" class="form-select" required>
                                <option value="">-- Select Supplier --</option>
                            </select>
                        </div>
                        <div class="col-md-2"><input type="date" id="purchase-date" class="form-control" required></div>
                        <div class="col-md-2"><input type="text" id="purchase-invoice-no" class="form-control" placeholder="Invoice No." required></div>
                        <div class="col-md-2"><input type="number" id="purchase-total" class="form-control" placeholder="Total Paid Amount" required min="1"></div>
                        <div class="col-md-2"><button type="submit" class="btn btn-success w-100"><i class="fas fa-save"></i> Record Purchase</button></div>
                    </form>
                </div>
            </div>

            <h4 class="mt-5 text-secondary">Purchase History</h4>
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="purchase-table">
                    <thead class="table-dark">
                        <tr>
                            <th>Date</th><th>Invoice No.</th><th>Supplier</th><th>Total Cost</th><th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="expense-screen" class="screen">
             <h2 class="text-secondary"><i class="fas fa-money-bill-wave"></i> Expense Tracking</h2>

             <div class="card mb-4">
                <div class="card-header bg-light">Add New Expense</div>
                <div class="card-body">
                    <form id="add-expense-form" class="row g-3">
                        <div class="col-md-3">
                            <select id="expense-category" class="form-select" required>
                                <option value="">-- Select Category --</option>
                                <option value="Rent">Rent</option>
                                <option value="Salary">Salary/Wages</option>
                                <option value="Utility">Utility Bills</option>
                                <option value="OfficeSupply">Office Supplies</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-2"><input type="date" id="expense-date" class="form-control" required></div>
                        <div class="col-md-2"><input type="number" id="expense-amount" class="form-control" placeholder="Amount (PKR)" required min="1"></div>
                        <div class="col-md-4"><input type="text" id="expense-description" class="form-control" placeholder="Description/Note" required></div>
                        <div class="col-md-1"><button type="submit" class="btn btn-danger w-100"><i class="fas fa-plus"></i> Add</button></div>
                    </form>
                </div>
            </div>

            <h4 class="mt-5 text-secondary">Expense History</h4>
             <div class="table-responsive">
                <table class="table table-bordered table-hover" id="expense-table">
                    <thead class="table-dark">
                        <tr>
                            <th>Date</th><th>Category</th><th>Amount (PKR)</th><th>Description</th><th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

        </section>


        <section id="reports-screen" class="screen">
            <h2 class="text-secondary"><i class="fas fa-chart-bar"></i> Business Reports</h2>
            <div class="report-tabs mb-3">
                <button onclick="renderReports('sales-report')" class="btn btn-danger report-btn active-report"><i class="fas fa-history"></i> Sales History</button>
                <button onclick="renderReports('profit-report')" class="btn btn-danger report-btn"><i class="fas fa-money-bill-wave"></i> Profit Report</button>
                <button onclick="renderReports('expiry-report')" class="btn btn-danger report-btn"><i class="fas fa-calendar-times"></i> Expiry Report</button>
            </div>

            <div class="d-flex align-items-center mb-3">
                <label for="report-start-date" class="me-2">Start Date:</label>
                <input type="date" id="report-start-date" class="form-control form-control-sm me-3" style="width: 150px;">
                <label for="report-end-date" class="me-2">End Date:</label>
                <input type="date" id="report-end-date" class="form-control form-control-sm me-3" style="width: 150px;">
                <button onclick="applyReportFilter()" class="btn btn-info btn-sm">Apply Filter</button>
            </div>


            <div id="report-content" class="card p-3 shadow-sm">
                </div>
        </section>
    </main>

    <div id="print-area"></div>

    <div class="modal fade" id="heldSalesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Held Sales / Pending Bills</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="held-sales-list"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="returnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">Process Refund/Return</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Enter the **Invoice ID** to load and process a return.</p>
                    <input type="number" id="return-invoice-id" class="form-control mb-3" placeholder="Invoice ID (e.g., 1001)">
                    <button class="btn btn-info w-100 mb-3" onclick="loadSaleForReturn()">Load Sale</button>
                    
                    <div id="return-details-area">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        
        // --- JSONBIN.IO CONFIGURATION (MUST CHANGE THESE) ---
        // ⚠️ یہاں آپ کی Master Key لگائی گئی ہے۔
        const MASTER_KEY = '$2a$10$F61hmBebmqQmwYgWNkRET.BpIO9GDLLa4b827vaVKfDnrsifEKg52'; 
        // ⚠️ یہاں آپ کی Bin ID لگائی گئی ہے۔
        const BIN_ID = '68fb09e5d0ea881f40b7429e';           
        const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        // ---------------------------------------------------

        // Global Data Arrays (Synced with JSONBin)
        let inventory = []; 
        // ... باقی سارا کوڈ یہاں سے شروع ہوتا ہے
        
        
        
        // Global Data Arrays (Session Storage is used for persistence)
        let inventory = []; 
        let sales = [];     
        let cart = [];      
        let heldSales = []; 
        let suppliers = []; 
        let purchases = []; 
        let expenses = [];  

        let currentFilterStartDate = null;
        let currentFilterEndDate = null;
        let lastSaleInvoiceId = null; // New variable to track the last completed sale's ID
        
        // --- DUMMY DATA (UPDATED: Future Expiry Dates and Type added) ---
        const DUMMY_INVENTORY = [
            // Ensure expiry dates are in the future (e.g., 2026/2027)
            { id: 1, name: "Panadol Extra", batch: "P-101", expiry: "2027-05-30", type: "Tab", price: 50.00, cost: 40.00, stock: 150, reorderLevel: 20, supplier: "Alpha Pharma" },
            { id: 2, name: "Amoxil 500mg", batch: "A-202", expiry: "2026-11-15", type: "Cap", price: 120.00, cost: 90.00, stock: 35, reorderLevel: 50, supplier: "Beta Supplies" },
            { id: 3, name: "Disprin", batch: "D-303", expiry: "2027-01-01", type: "Tab", price: 30.00, cost: 20.00, stock: 5, reorderLevel: 10, supplier: "Alpha Pharma" },
            { id: 4, name: "Vitamin C", batch: "V-404", expiry: "2026-04-01", type: "Syp", price: 200.00, cost: 150.00, stock: 100, reorderLevel: 5, supplier: "Gamma Distributors" }
        ];
        const DUMMY_SUPPLIERS = [
             { id: 1, name: "Alpha Pharma", phone: "0300-111222" },
             { id: 2, name: "Beta Supplies", phone: "0321-333444" },
             { id: 3, name: "Gamma Distributors", phone: "0333-555666" }
        ];
        
        // --- Core Utility Functions ---

        function dateInRange(dateStr, startStr, endStr) {
            return dateStr >= startStr && dateStr <= endStr;
        }

        /** Loads data from Session Storage or initializes with dummy data. */
        function loadData() {
            try {
                // IMPORTANT: Ensure correct structure when loading/initializing
                const storedInventory = JSON.parse(sessionStorage.getItem('medicalInventory'));
                inventory = storedInventory && storedInventory.length > 0 ? storedInventory : [...DUMMY_INVENTORY]; 
                
                sales = JSON.parse(sessionStorage.getItem('salesRecords')) || [];
                heldSales = JSON.parse(sessionStorage.getItem('heldSales')) || [];
                suppliers = JSON.parse(sessionStorage.getItem('suppliers')) || [...DUMMY_SUPPLIERS];
                purchases = JSON.parse(sessionStorage.getItem('purchaseRecords')) || [];
                expenses = JSON.parse(sessionStorage.getItem('expenseRecords')) || [];
            } catch (e) {
                console.error("Error loading data from session storage:", e);
                inventory = [...DUMMY_INVENTORY]; 
                suppliers = [...DUMMY_SUPPLIERS];
            }
        }

        /** Saves all major data arrays to Session Storage. */
        function saveAllData() {
            sessionStorage.setItem('medicalInventory', JSON.stringify(inventory));
            sessionStorage.setItem('salesRecords', JSON.stringify(sales));
            sessionStorage.setItem('heldSales', JSON.stringify(heldSales));
            sessionStorage.setItem('suppliers', JSON.stringify(suppliers));
            sessionStorage.setItem('purchaseRecords', JSON.stringify(purchases));
            sessionStorage.setItem('expenseRecords', JSON.stringify(expenses));
            updateHeldCount();
        }

        /** Switches between different POS screens (Tabs). */
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            const screenElement = document.getElementById(screenId);
            if (screenElement) screenElement.classList.add('active');

            document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.tabs button[data-target="${screenId}"]`);
            if (activeBtn) activeBtn.classList.add('active');

            if (screenId === 'inventory-screen') {
                renderInventory();
                renderSupplierList();
                populateSupplierDropdowns();
            } else if (screenId === 'pos-screen') {
                searchProduct(); 
                renderCart();
                updatePrintButtonVisibility(); // Check and show print button on POS screen
            } else if (screenId === 'reports-screen') {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('report-start-date').value = today;
                document.getElementById('report-end-date').value = today;
                currentFilterStartDate = today;
                currentFilterEndDate = today;
                renderReports('sales-report');
            } else if (screenId === 'dashboard-screen') {
                renderDashboard();
            } else if (screenId === 'purchase-screen') {
                renderPurchaseHistory();
                populateSupplierDropdowns();
            } else if (screenId === 'expense-screen') {
                renderExpenseHistory();
            }
        }
        
        /** Updates the count of held sales in the POS tab. */
        function updateHeldCount() {
            const heldCountElement = document.getElementById('held-count');
            if(heldCountElement) {
                heldCountElement.textContent = heldSales.length;
            }
        }

        /** Checks if the last sale ID exists and updates the manual print button */
        function updatePrintButtonVisibility() {
            const btn = document.getElementById('print-last-invoice-btn');
            if(btn) {
                if (lastSaleInvoiceId) {
                    btn.style.display = 'block';
                } else {
                    btn.style.display = 'none';
                }
            }
        }

        function printLastInvoice() {
            if (!lastSaleInvoiceId) {
                alert("No sale has been completed yet to print.");
                return;
            }
            const sale = sales.find(s => s.invoice === lastSaleInvoiceId && s.type === 'Sale');
            if (sale) {
                printInvoice(sale);
            } else {
                 alert("Last sale details not found or it was a refund.");
            }
        }

        // --- DASHBOARD LOGIC ---

        function getDateRange(filter) {
            const now = new Date();
            let startDate = new Date();
            let endDate = new Date();
            endDate.setHours(23, 59, 59, 999);

            switch (filter) {
                case 'day': startDate.setHours(0, 0, 0, 0); break;
                case 'week': startDate.setDate(now.getDate() - 7); startDate.setHours(0, 0, 0, 0); break;
                case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); startDate.setHours(0, 0, 0, 0); break;
                case 'all': default: startDate = new Date(0); break;
            }
            
            return { 
                startDate: startDate.toISOString().split('T')[0], 
                endDate: endDate.toISOString().split('T')[0] 
            };
        }

        function renderDashboard() {
            const filter = document.getElementById('dashboard-filter')?.value || 'day';
            const { startDate, endDate } = getDateRange(filter);

            let totalSales = 0;
            let totalProfit = 0;
            let totalExpenses = 0;
            let periodName = document.getElementById('dashboard-filter').options[document.getElementById('dashboard-filter').selectedIndex].text;
            
            const filteredSales = sales.filter(sale => dateInRange(sale.date, startDate, endDate));
            filteredSales.forEach(sale => {
                totalSales += sale.total > 0 ? sale.total : 0; // Only count actual sales revenue
                totalProfit += sale.profit;
            });

            const filteredExpenses = expenses.filter(exp => dateInRange(exp.date, startDate, endDate));
            filteredExpenses.forEach(exp => {
                totalExpenses += exp.amount;
            });
            
            const netProfitAfterExpense = totalProfit - totalExpenses;

            const reorderNeededCount = inventory.filter(item => {
                const isLowStock = item.stock <= item.reorderLevel;
                const isExpired = new Date(item.expiry) < new Date(new Date().toISOString().split('T')[0]);
                return isLowStock || isExpired;
            }).length;

            document.getElementById('dashboard-period').textContent = periodName;
            document.getElementById('dashboard-period-2').textContent = periodName;
            document.getElementById('dashboard-period-3').textContent = periodName;

            document.getElementById('dashboard-sales').textContent = totalSales.toFixed(2) + ' PKR';
            document.getElementById('dashboard-profit').textContent = netProfitAfterExpense.toFixed(2) + ' PKR';
            document.getElementById('dashboard-expenses').textContent = totalExpenses.toFixed(2) + ' PKR';
            document.getElementById('dashboard-reorder-needed').textContent = reorderNeededCount;
            
            // Render Recent Sales Table
            const today = new Date().toISOString().split('T')[0];
            const salesToday = sales.filter(s => s.date === today && s.total > 0); 
            const container = document.getElementById('dashboard-recent-sales-table');

            if (salesToday.length === 0) {
                container.innerHTML = '<p class="alert alert-info">No sales recorded today.</p>';
                return;
            }

            let tableHTML = `<table class="table table-striped table-sm">
                <thead class="table-secondary"><tr><th>Invoice ID</th><th>Time</th><th>Customer</th><th>Total</th></tr></thead><tbody>`;

            salesToday.slice().sort((a, b) => new Date(b.fullDate) - new Date(a.fullDate)).slice(0, 5).forEach(sale => {
                const time = new Date(sale.fullDate).toLocaleTimeString();
                const customerDisplay = sale.customerName || 'N/A';
                tableHTML += `<tr><td>${sale.invoice}</td><td>${time}</td><td>${customerDisplay}</td><td>${sale.total.toFixed(2)}</td></tr>`;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        // --- INVENTORY / SUPPLIER LOGIC ---

        function populateSupplierDropdowns() {
            const inventoryDropdown = document.getElementById('p-supplier');
            const purchaseDropdown = document.getElementById('purchase-supplier');

            if (inventoryDropdown) inventoryDropdown.innerHTML = '<option value="">Supplier (Optional)</option>';
            if (purchaseDropdown) purchaseDropdown.innerHTML = '<option value="">-- Select Supplier --</option>';

            suppliers.forEach(supplier => {
                const option = `<option value="${supplier.name}">${supplier.name}</option>`;
                if (inventoryDropdown) inventoryDropdown.innerHTML += option;
                if (purchaseDropdown) purchaseDropdown.innerHTML += option;
            });
        }

        function handleAddSupplier(event) {
            event.preventDefault();
            const name = document.getElementById('s-name')?.value.trim();
            const phone = document.getElementById('s-phone')?.value.trim();

            if (!name || suppliers.some(s => s.name.toLowerCase() === name.toLowerCase())) {
                alert("Supplier name is required or already exists.");
                return;
            }

            const newId = suppliers.length > 0 ? Math.max(...suppliers.map(s => s.id)) + 1 : 1;
            suppliers.push({ id: newId, name: name, phone: phone });
            saveAllData();
            renderSupplierList();
            populateSupplierDropdowns();
            document.getElementById('add-supplier-form').reset();
            alert(`Supplier "${name}" added.`);
        }

        function renderSupplierList() {
            const container = document.getElementById('supplier-list-container');
            if (!container) return;

            // Filter out CSV-imported 'N/A (CSV Import)' suppliers if they exist
            const displaySuppliers = suppliers.filter(s => s.name !== 'N/A (CSV Import)');

            if (displaySuppliers.length === 0) {
                container.innerHTML = '<p class="alert alert-warning">No suppliers added yet.</p>';
                return;
            }

            let html = `<table class="table table-sm table-striped"><thead><tr><th>ID</th><th>Name</th><th>Phone</th><th>Action</th></tr></thead><tbody>`;
            displaySuppliers.forEach(s => {
                html += `<tr><td>${s.id}</td><td>${s.name}</td><td>${s.phone}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteSupplier(${s.id})"><i class="fas fa-trash"></i></button></td></tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function deleteSupplier(id) {
            if (confirm("Are you sure you want to delete this supplier?")) {
                suppliers = suppliers.filter(s => s.id !== id);
                saveAllData();
                renderSupplierList();
                populateSupplierDropdowns();
            }
        }

        function renderInventory() {
            const tableBody = document.getElementById('inventory-table')?.querySelector('tbody');
            if (!tableBody) return; 
            
            tableBody.innerHTML = ''; 
            const sortedInventory = [...inventory].sort((a, b) => a.name.localeCompare(b.name));
            const today = new Date(new Date().toISOString().split('T')[0]);

            sortedInventory.forEach(item => {
                const row = tableBody.insertRow();
                let rowClass = '';
                const expiryDate = new Date(item.expiry);
                const diffDays = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

                // Priority 1: Expired
                if (expiryDate < today) {
                    rowClass = 'expired-row';
                // Priority 2: Re-order Needed (Stock is low)
                } else if (item.stock <= item.reorderLevel) {
                    rowClass = 'reorder-needed';
                // Priority 3: Soon to expire (within 90 days)
                } else if (diffDays <= 90 && diffDays > 0) { 
                    rowClass = 'soon-to-expire-row';
                // Priority 4: Just low stock (Below 10 and not critical)
                } else if (item.stock < 10) {
                     rowClass = 'low-stock-row';
                }

                row.className = rowClass;
                
                // Set Supplier to 'N/A' if empty/null
                const supplierDisplay = item.supplier || 'N/A'; 

                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.batch}</td>
                    <td>${item.expiry}</td>
                    <td>${item.type || 'N/A'}</td> <td>${item.price.toFixed(2)}</td>
                    <td>${item.cost.toFixed(2)}</td>
                    <td>${item.reorderLevel}</td>
                    <td>${item.stock}</td>
                    <td>${supplierDisplay}</td>
                    <td><button onclick="deleteProduct(${item.id})" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button></td>
                `;
            });
        }

        function handleAddProduct(event) {
            event.preventDefault();
            
            const name = document.getElementById('p-name')?.value.trim();
            const batch = document.getElementById('p-batch')?.value.trim();
            const expiry = document.getElementById('p-expiry')?.value;
            const type = document.getElementById('p-type')?.value.trim(); // Get new field value
            const price = parseFloat(document.getElementById('p-price')?.value);
            const cost = parseFloat(document.getElementById('p-cost')?.value); 
            const stock = parseInt(document.getElementById('p-qty')?.value);
            const reorderLevel = parseInt(document.getElementById('p-reorder')?.value);
            // Supplier is now optional - default to 'N/A' if empty
            const supplier = document.getElementById('p-supplier')?.value || 'N/A'; 

            // This function handles both form submission and CSV processing logic
            processInventoryItem({ name, batch, expiry, type, price, cost, stock, reorderLevel, supplier });
            document.getElementById('add-product-form')?.reset();
        }

        /** Unified logic to add or update an item from form or CSV */
        function processInventoryItem({ name, batch, expiry, type, price, cost, stock, reorderLevel, supplier }) {
             // Basic validation (more comprehensive validation can be added)
            if (price < cost) {
                 alert(`Error for ${name}: Selling Price must be higher than Cost Price.`);
                 return;
            }
            if (isNaN(stock) || stock < 0 || isNaN(price) || isNaN(cost)) {
                 alert(`Error for ${name}: Invalid number for stock, price, or cost.`);
                 return;
            }
            
            // Set supplier to 'N/A' if it comes in as an empty string from form/CSV
            const finalSupplier = supplier || 'N/A'; 

            const existingItem = inventory.find(item => 
                item.name.toLowerCase() === name.toLowerCase() && 
                item.batch.toLowerCase() === batch.toLowerCase()
            );

            if (existingItem) {
                // Update Logic (Weighted Average Cost)
                const oldTotalValue = existingItem.stock * existingItem.cost;
                const newTotalValue = stock * cost;
                const newTotalStock = existingItem.stock + stock;

                existingItem.cost = (oldTotalValue + newTotalValue) / newTotalStock;
                
                existingItem.stock = newTotalStock;
                existingItem.price = price; 
                existingItem.type = type; // Update type if necessary
                existingItem.reorderLevel = reorderLevel;
                existingItem.supplier = finalSupplier; // Update supplier on restock
                // Update Expiry date if newer
                if (new Date(expiry) > new Date(existingItem.expiry)) {
                    existingItem.expiry = expiry;
                }
                
                // Alert only for manual form entry
                if (arguments[0].name === name && arguments.length === 1) { 
                    alert(`Stock for '${name}' (Batch: ${batch}) updated! New Stock: ${existingItem.stock}. New Avg Cost: ${existingItem.cost.toFixed(2)}.`);
                }
            } else {
                // ADD NEW ITEM
                const newId = inventory.length > 0 ? Math.max(...inventory.map(p => p.id)) + 1 : 1;

                const newItem = {
                    id: newId, name: name, batch: batch, expiry: expiry, type: type, price: price, // Include Type
                    cost: cost, stock: stock, reorderLevel: reorderLevel, supplier: finalSupplier // Use finalSupplier
                };

                inventory.push(newItem);
                
                // Alert only for manual form entry
                if (arguments[0].name === name && arguments.length === 1) { 
                    alert(`New Item '${name}' added successfully!`);
                }
            }
        }
        
        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvData = e.target.result;
                const lines = csvData.split('\n').filter(line => line.trim() !== '');

                if (lines.length <= 1) {
                    alert("The CSV file is empty or contains only headers.");
                    return;
                }
                
                // 1. Get Headers and define required format
                const headers = lines[0].toLowerCase().trim().split(',').map(h => h.trim());
                const requiredHeaders = ['name', 'batch', 'expiry', 'type', 'price', 'cost', 'stock', 'reorderlevel', 'supplier'];

                const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));

                if (missingHeaders.length > 0) {
                    alert(`Import Failed: CSV is missing required headers: ${missingHeaders.join(', ')}. Please use the format: ${requiredHeaders.join(', ')}`);
                    return;
                }
                
                let successCount = 0;
                let failCount = 0;
                let newSupplierCount = 0;

                // 2. Process each line starting from the second row
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length < requiredHeaders.length) {
                        failCount++;
                        continue;
                    }
                    
                    const itemData = {};
                    headers.forEach((header, index) => {
                        itemData[header] = values[index].trim();
                    });

                    try {
                        let supplierName = itemData.supplier || 'N/A'; // Handle optional supplier

                        const item = {
                            name: itemData.name,
                            batch: itemData.batch,
                            expiry: itemData.expiry,
                            type: itemData.type,
                            price: parseFloat(itemData.price),
                            cost: parseFloat(itemData.cost),
                            stock: parseInt(itemData.stock),
                            reorderLevel: parseInt(itemData.reorderlevel),
                            supplier: supplierName
                        };

                        // Add new supplier if it's not 'N/A' and doesn't exist
                        if (item.supplier !== 'N/A' && !suppliers.some(s => s.name === item.supplier)) {
                            const newId = suppliers.length > 0 ? Math.max(...suppliers.map(s => s.id)) + 1 : 1;
                            suppliers.push({ id: newId, name: item.supplier, phone: 'N/A (CSV Import)' });
                            newSupplierCount++;
                        }
                        
                        // Process the item (Add/Update logic)
                        processInventoryItem(item); 
                        successCount++;
                    } catch (e) {
                        console.error(`Error processing line ${i + 1}: ${e}`);
                        failCount++;
                    }
                }
                
                saveAllData();
                renderInventory();
                populateSupplierDropdowns();

                alert(`CSV Import Complete!\n- Success: ${successCount} items processed.\n- Failed: ${failCount} items skipped.\n- New Suppliers Added: ${newSupplierCount}.`);
            };

            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        function deleteProduct(id) {
            if (confirm("Are you sure you want to delete this item?")) {
                inventory = inventory.filter(item => item.id !== id);
                saveAllData();
                renderInventory();
            }
        }
        
        // --- POS/Billing Logic (Cart, Hold, Returns) ---

        function searchProduct() {
            const container = document.getElementById('product-tiles-container');
            const searchInput = document.getElementById('product-search');
            if (!container || !searchInput) return;
            
            const query = searchInput.value.toLowerCase();
            container.innerHTML = '';
            
            const today = new Date(new Date().toISOString().split('T')[0]);

            // FIX: Ensure all non-expired, in-stock items are shown.
            const filtered = inventory.filter(item => 
                item.stock > 0 && 
                new Date(item.expiry) >= today && // Crucial fix: Only show non-expired stock
                (item.name.toLowerCase().includes(query) || item.batch.toLowerCase().includes(query))
            );

            if (filtered.length === 0 && inventory.length > 0 && query === "") {
                 container.innerHTML = '<p class="alert alert-warning">No non-expired, in-stock products match the search. Check Inventory screen for details.</p>';
                 return;
            }

            filtered.forEach(item => {
                const isLowStock = item.stock <= item.reorderLevel;
                const lowStockBadge = isLowStock ? '<span class="badge bg-danger">Low Stock!</span>' : '';
                const typeDisplay = item.type ? `<small class="text-info">(${item.type})</small>` : '';

                const tile = document.createElement('div');
                tile.className = 'col';
                tile.innerHTML = `
                    <div class="card product-tile p-2 h-100" onclick="addToCart(${item.id}, '${item.batch}')">
                        <h5 class="card-title">${item.name} ${typeDisplay} ${lowStockBadge}</h5>
                        <p class="card-text price-tag">${item.price.toFixed(2)} PKR</p>
                        <small class="text-muted">Stock: ${item.stock}</small>
                    </div>
                `;
                container.appendChild(tile);
            });
        }

        function addToCart(id, batch) {
            const product = inventory.find(item => item.id === id && item.batch === batch);
            if (!product || product.stock < 1) return alert("Product out of stock!");

            const existingItem = cart.find(item => item.id === product.id && item.batch === product.batch);

            if (existingItem) {
                if (existingItem.qty + 1 > product.stock) {
                    return alert(`Max stock reached for ${product.name}!`);
                }
                existingItem.qty += 1;
            } else {
                cart.push({
                    id: product.id, name: product.name, batch: product.batch, 
                    price: product.price, cost: product.cost, stock: product.stock, qty: 1
                });
            }

            renderCart();
        }

        function updateCartQuantity(index, newQty) {
            const qty = parseInt(newQty);
            const item = cart[index];
            
            if (isNaN(qty) || qty <= 0) {
                return removeFromCart(index);
            }
            if (qty > item.stock) { 
                alert(`Cannot add ${qty}. Only ${item.stock} in stock.`);
                // Revert the input field value to the previous valid quantity
                document.getElementById('cart-table').rows[index + 1].cells[1].querySelector('input').value = item.qty;
                return;
            }
            
            item.qty = qty;
            renderCart();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }

        function renderCart(heldCustomerName = '') {
            const tableBody = document.getElementById('cart-table')?.querySelector('tbody');
            const cartTitle = document.getElementById('cart-title');

            if (!tableBody || !cartTitle) return;
            
            tableBody.innerHTML = '';
            
            cartTitle.textContent = heldCustomerName ? `Cart (${heldCustomerName})` : 'Cart';
            
            cart.forEach((item, index) => {
                const total = item.qty * item.price;
                const row = tableBody.insertRow();
                
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>
                        <input type="number" value="${item.qty}" min="1" max="${item.stock}" 
                            onchange="updateCartQuantity(${index}, this.value)" style="width: 50px;">
                    </td>
                    <td>${total.toFixed(2)}</td>
                    <td><button onclick="removeFromCart(${index})" class="btn btn-danger btn-sm p-1">X</button></td>
                `;
            });

            calculateTotal();
        }

        function calculateTotal() {
            let subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            
            const taxInput = document.getElementById('tax-percent');
            const taxPercent = taxInput ? parseFloat(taxInput.value) || 0 : 0;
            
            const taxAmount = subtotal * (taxPercent / 100);
            const subtotalPlusTax = subtotal + taxAmount;
            
            const discountInput = document.getElementById('discount');
            const discountPercent = discountInput ? parseFloat(discountInput.value) || 0 : 0;
            
            const discountAmount = subtotalPlusTax * (discountPercent / 100);
            let grandTotal = subtotalPlusTax - discountAmount;
            
            if (grandTotal < 0) grandTotal = 0; 

            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('tax-amount').textContent = taxAmount.toFixed(2);
            document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
        }

        function resetPOSState() {
            cart = []; 
            renderCart();
            document.getElementById('discount').value = 0;
            document.getElementById('tax-percent').value = 0;
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-phone').value = '';
            document.getElementById('payment-method').value = 'Cash';
            searchProduct(); 
        }

        function holdSale() {
            if (cart.length === 0) {
                alert("Cart is empty. Cannot hold an empty sale.");
                return;
            }

            const customerName = document.getElementById('customer-name').value.trim() || `Held Bill #${heldSales.length + 1}`;
            
            heldSales.push({
                cart: JSON.parse(JSON.stringify(cart)), 
                customerName: customerName,
                customerPhone: document.getElementById('customer-phone').value.trim(),
                taxPercent: parseFloat(document.getElementById('tax-percent').value) || 0,
                discount: parseFloat(document.getElementById('discount').value) || 0,
                heldTime: new Date().toLocaleString()
            });

            saveAllData();
            resetPOSState();
            
            const messageDiv = document.getElementById('sale-message');
            messageDiv.innerHTML = `<div class="alert alert-warning mt-2">Sale for <strong>${customerName}</strong> held successfully.</div>`;
            setTimeout(() => messageDiv.innerHTML = '', 3000);
        }

        function renderHeldSalesList() {
            const listDiv = document.getElementById('held-sales-list');
            if (!listDiv) return;

            if (heldSales.length === 0) {
                listDiv.innerHTML = '<p class="alert alert-info">No pending sales are currently held.</p>';
                return;
            }

            let html = `<ul class="list-group">`;
            heldSales.forEach((sale, index) => {
                const total = calculateHeldTotal(sale);
                html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${sale.customerName}</strong> 
                            <small class="text-muted">(${sale.heldTime})</small>
                            <br>Total Items: ${sale.cart.length} | Net Total: ${total.toFixed(2)} PKR
                        </div>
                        <div>
                            <button class="btn btn-sm btn-success me-2" onclick="resumeHeldSale(${index})" data-bs-dismiss="modal">Resume</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteHeldSale(${index})" data-bs-dismiss="modal">Delete</button>
                        </div>
                    </li>
                `;
            });
            html += `</ul>`;
            listDiv.innerHTML = html;
        }

        function calculateHeldTotal(sale) {
            let subtotal = sale.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const subtotalPlusTax = subtotal * (1 + sale.taxPercent / 100);
            let total = subtotalPlusTax * (1 - sale.discount / 100);
            return total < 0 ? 0 : total;
        }

        function resumeHeldSale(index) {
            const heldSale = heldSales[index];

            // 1. Check stock availability before resuming
            for (const heldItem of heldSale.cart) {
                const inventoryItem = inventory.find(i => i.id === heldItem.id && i.batch === heldItem.batch);
                if (!inventoryItem || inventoryItem.stock < heldItem.qty) {
                    alert(`Cannot resume sale: Not enough stock for ${heldItem.name} (Batch: ${heldItem.batch}). Available: ${inventoryItem ? inventoryItem.stock : 0}, Needed: ${heldItem.qty}.`);
                    return; 
                }
            }

            // 2. Load the state
            resetPOSState();
            cart = heldSale.cart;
            document.getElementById('customer-name').value = heldSale.customerName;
            document.getElementById('customer-phone').value = heldSale.customerPhone;
            document.getElementById('tax-percent').value = heldSale.taxPercent;
            document.getElementById('discount').value = heldSale.discount;
            
            // 3. Remove from held list and render
            heldSales.splice(index, 1);
            saveAllData();
            renderCart(heldSale.customerName);
            updateHeldCount(); 

            // 4. Show notification
            const messageDiv = document.getElementById('sale-message');
            messageDiv.innerHTML = `<div class="alert alert-success mt-2">Sale for <strong>${heldSale.customerName}</strong> resumed.</div>`;
            setTimeout(() => messageDiv.innerHTML = '', 3000);
        }

        function deleteHeldSale(index) {
            if (confirm("Are you sure you want to permanently delete this held sale?")) {
                heldSales.splice(index, 1);
                saveAllData();
                updateHeldCount();
                alert("Held sale deleted.");
            }
        }
        
        function finalizeSale() {
            if (cart.length === 0) {
                alert("Cart is empty. Please add items to complete the sale.");
                return;
            }

            const grandTotalText = document.getElementById('grand-total').textContent;
            const grandTotal = parseFloat(grandTotalText);
            const subtotal = parseFloat(document.getElementById('subtotal').textContent);
            const discountPercent = parseFloat(document.getElementById('discount').value) || 0;
            const taxPercent = parseFloat(document.getElementById('tax-percent').value) || 0;
            const taxAmount = parseFloat(document.getElementById('tax-amount').textContent);
            const paymentMethod = document.getElementById('payment-method').value;
            const customerName = document.getElementById('customer-name').value.trim();
            const customerPhone = document.getElementById('customer-phone').value.trim();

            const invoiceId = sales.length > 0 ? Math.max(...sales.map(s => s.invoice)) + 1 : 1001;
            const fullDate = new Date();
            const saleDate = fullDate.toISOString().split('T')[0];

            let totalCost = 0;
            let soldItems = [];

            // 1. Update Inventory and calculate Cost/Profit
            for (const cartItem of cart) {
                const inventoryItem = inventory.find(i => i.id === cartItem.id && i.batch === cartItem.batch);
                
                if (!inventoryItem || inventoryItem.stock < cartItem.qty) {
                    alert(`Transaction failed: Not enough stock for ${cartItem.name} (Batch: ${cartItem.batch}).`);
                    return;
                }

                // Decrease stock
                inventoryItem.stock -= cartItem.qty;
                
                // Track cost
                totalCost += inventoryItem.cost * cartItem.qty; // Use inventory's cost (weighted average)
                
                // Prepare sold item record
                soldItems.push({
                    id: cartItem.id,
                    name: cartItem.name,
                    batch: cartItem.batch,
                    qty: cartItem.qty,
                    sellPrice: cartItem.price,
                    costPrice: inventoryItem.cost, // Record actual cost used for profit calculation
                    lineTotal: cartItem.price * cartItem.qty
                });
            }

            const totalProfit = subtotal - totalCost;

            // 2. Record Sale
            const newSale = {
                invoice: invoiceId,
                date: saleDate,
                fullDate: fullDate.toISOString(),
                total: grandTotal,
                subtotal: subtotal,
                taxPercent: taxPercent,
                taxAmount: taxAmount,
                discountPercent: discountPercent,
                totalCost: totalCost,
                profit: totalProfit,
                paymentMethod: paymentMethod,
                customerName: customerName,
                customerPhone: customerPhone,
                items: soldItems,
                type: 'Sale'
            };

            sales.push(newSale);
            saveAllData();
            
            // 3. AUTO PRINT DISABLED - only record the ID for manual print
            lastSaleInvoiceId = invoiceId;

            // 4. Reset POS
            resetPOSState();
            
            const messageDiv = document.getElementById('sale-message');
            messageDiv.innerHTML = `<div class="alert alert-success mt-2">Sale completed! Invoice ID: <strong>${invoiceId}</strong>. Total: ${grandTotal.toFixed(2)} PKR</div>`;
            setTimeout(() => messageDiv.innerHTML = '', 5000);
            
            // Re-render inventory to update stock tiles
            searchProduct(); 
            renderDashboard();
            updatePrintButtonVisibility(); // Show print button for the just completed sale
        }

        function printInvoice(sale) {
            let printContent = `
                <div class="p-3">
                    <h5 style="text-align:center; margin-bottom: 5px;">PHARMACY POS DEMO</h5>
                    <p style="text-align:center; font-size: 9pt;">Date: ${new Date(sale.fullDate).toLocaleString()}</p>
                    <p style="font-size: 9pt;">Invoice ID: ${sale.invoice}</p>
                    <p style="font-size: 9pt;">Customer: ${sale.customerName || 'Walk-in'}</p>
                    <p style="font-size: 9pt;">Payment: ${sale.paymentMethod}</p>
                    <hr style="border-top: 1px dashed black;">
                    
                    <div style="display: flex; font-size: 9pt; font-weight: bold; margin-bottom: 5px;">
                        <span style="width: 50%;">Item</span>
                        <span style="width: 15%; text-align: center;">Qty</span>
                        <span style="width: 35%; text-align: right;">Total</span>
                    </div>
                    <hr style="border-top: 1px dashed black;">
            `;

            sale.items.forEach(item => {
                printContent += `
                    <div style="display: flex; font-size: 9pt; margin-bottom: 3px;">
                        <span style="width: 50%;">${item.name}</span>
                        <span style="width: 15%; text-align: center;">${item.qty}</span>
                        <span style="width: 35%; text-align: right;">${item.lineTotal.toFixed(2)}</span>
                    </div>
                `;
            });

            printContent += `
                    <hr style="border-top: 1px dashed black; margin-top: 10px;">
                    <div style="font-size: 9pt; display: flex; justify-content: space-between;">
                        <span>Subtotal:</span>
                        <span style="font-weight: bold;">${sale.subtotal.toFixed(2)} PKR</span>
                    </div>
                    <div style="font-size: 9pt; display: flex; justify-content: space-between;">
                        <span>Tax (${sale.taxPercent}%):</span>
                        <span style="font-weight: bold;">${sale.taxAmount.toFixed(2)} PKR</span>
                    </div>
                    <div style="font-size: 9pt; display: flex; justify-content: space-between;">
                        <span>Discount (${sale.discountPercent}%):</span>
                        <span style="font-weight: bold;">${((sale.subtotal + sale.taxAmount) * (sale.discountPercent / 100)).toFixed(2)} PKR</span>
                    </div>
                    <hr style="border-top: 1px solid black;">
                    <div style="font-size: 11pt; font-weight: bold; display: flex; justify-content: space-between;">
                        <span>GRAND TOTAL:</span>
                        <span>${sale.total.toFixed(2)} PKR</span>
                    </div>
                    
                    <div class="invoice-footer">
                        Thank You!
                        <br>
                        (Demo: Data is stored locally in your browser.)
                    </div>
                </div>
            `;

            document.getElementById('print-area').innerHTML = printContent;
            window.print();
            document.getElementById('print-area').innerHTML = '';
        }

        // --- REFUND/RETURN LOGIC ---

        function showReturnModal() {
            // Reset modal content
            document.getElementById('return-invoice-id').value = '';
            document.getElementById('return-details-area').innerHTML = '';
            // Show modal
            const returnModal = new bootstrap.Modal(document.getElementById('returnModal'));
            returnModal.show();
        }

        function loadSaleForReturn() {
            const invoiceId = parseInt(document.getElementById('return-invoice-id').value);
            const sale = sales.find(s => s.invoice === invoiceId && s.type === 'Sale');
            const detailsArea = document.getElementById('return-details-area');

            detailsArea.innerHTML = '';
            
            if (!sale) {
                detailsArea.innerHTML = `<div class="alert alert-danger mt-3">Invoice ID ${invoiceId} not found or is a refund/return transaction.</div>`;
                return;
            }
            
            // Calculate item price after discount and tax for accurate refund per item
            const taxFactor = 1 + (sale.taxPercent / 100);
            const discountFactor = 1 - (sale.discountPercent / 100);

            let html = `
                <div class="alert alert-success mt-3">
                    <strong>Original Sale Details (Invoice ${sale.invoice})</strong>
                    <p>Date: ${new Date(sale.fullDate).toLocaleDateString()}</p>
                    <p>Total Paid: ${sale.total.toFixed(2)} PKR</p>
                    <p>Customer: ${sale.customerName || 'N/A'}</p>
                </div>
                <h6 class="text-danger">Select Items to Return (Max Qty: Original Sale Qty)</h6>
                <table class="table table-sm table-striped">
                    <thead><tr><th>Item</th><th>Max Qty</th><th>Return Qty</th></tr></thead>
                    <tbody>
            `;

            sale.items.forEach((item, index) => {
                // Calculate effective selling price per unit for precise refund amount
                const effectivePrice = (item.sellPrice * taxFactor * discountFactor) / (1 + (sale.taxPercent / 100) * (sale.discountPercent / 100)); // Simplified calculation is tricky, but we use the total final price for refund.
                
                // Let's rely on the simple calculation: Total Refund Price / Total Units.
                // Re-calculating the effective price per unit based on final sale total for accuracy:
                const effectiveUnitFinalPrice = (sale.total / sale.items.reduce((acc, i) => acc + i.qty, 0)); // Crude but simple for demo.
                
                // Better approach: Calculate effective price per unit for THIS item:
                const itemSubtotal = item.lineTotal; // Price * Qty
                const itemGrandTotal = (itemSubtotal / sale.subtotal) * sale.total; // Weighted final total
                const itemEffectivePrice = itemGrandTotal / item.qty; // Price per unit after discount/tax

                html += `
                    <tr>
                        <td>${item.name} (${item.batch})</td>
                        <td>${item.qty}</td>
                        <td>
                            <input type="number" id="return-qty-${index}" min="0" max="${item.qty}" value="0" 
                                class="form-control form-control-sm return-qty-input" style="width: 60px;"
                                data-price="${itemEffectivePrice}" data-cost="${item.costPrice}" data-id="${item.id}" data-batch="${item.batch}" data-max="${item.qty}">
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                <h5 class="text-danger mt-3">Refund Amount: <span id="estimated-refund">0.00</span> PKR</h5>
                <button class="btn btn-danger w-100" onclick="processReturn(${sale.invoice})">Process Refund</button>
            `;

            detailsArea.innerHTML = html;
            
            // Add event listeners to calculate refund amount dynamically
            document.querySelectorAll('.return-qty-input').forEach(input => {
                input.addEventListener('input', calculateEstimatedRefund);
            });
        }

        function calculateEstimatedRefund() {
            let estimatedTotal = 0;
            document.querySelectorAll('.return-qty-input').forEach(input => {
                let qty = parseInt(input.value) || 0;
                const price = parseFloat(input.dataset.price);
                const maxQty = parseInt(input.dataset.max);

                if (qty < 0) qty = 0;
                if (qty > maxQty) qty = maxQty;
                input.value = qty;

                estimatedTotal += qty * price;
            });

            document.getElementById('estimated-refund').textContent = estimatedTotal.toFixed(2);
        }

        function processReturn(originalInvoiceId) {
            const sale = sales.find(s => s.invoice === originalInvoiceId && s.type === 'Sale');
            if (!sale) return alert("Original sale not found.");

            let refundItems = [];
            let refundAmount = 0;
            let totalRefundCost = 0;

            document.querySelectorAll('.return-qty-input').forEach(input => {
                const qty = parseInt(input.value) || 0;
                
                if (qty > 0) {
                    const price = parseFloat(input.dataset.price); // Effective Price
                    const cost = parseFloat(input.dataset.cost);
                    const id = parseInt(input.dataset.id);
                    const batch = input.dataset.batch;
                    
                    const originalItem = sale.items.find(item => item.id === id && item.batch === batch);

                    if (!originalItem) return; // Should not happen

                    
                    refundItems.push({
                        id: id,
                        name: originalItem.name,
                        batch: batch,
                        qty: qty,
                        sellPrice: originalItem.sellPrice, // Original sell price (for consistency)
                        costPrice: cost,
                        lineTotal: qty * price // Total refund amount for this line (effective price)
                    });

                    refundAmount += qty * price;
                    totalRefundCost += qty * cost;

                    // Update Inventory: Return stock to inventory
                    const inventoryItem = inventory.find(i => i.id === id && i.batch === batch);
                    if (inventoryItem) {
                        inventoryItem.stock += qty;
                    }
                }
            });

            if (refundItems.length === 0) {
                return alert("No items selected for refund.");
            }

            if (!confirm(`Are you sure you want to process a refund of ${refundAmount.toFixed(2)} PKR?`)) {
                return;
            }

            // Record Refund Transaction
            const refundInvoiceId = sales.length > 0 ? Math.max(...sales.map(s => s.invoice)) + 1 : 1001;
            const fullDate = new Date();
            const refundDate = fullDate.toISOString().split('T')[0];

            const newRefund = {
                invoice: refundInvoiceId,
                date: refundDate,
                fullDate: fullDate.toISOString(),
                total: -refundAmount, // Negative total indicates refund
                subtotal: -refundAmount,
                taxPercent: 0,
                taxAmount: 0,
                discountPercent: 0,
                totalCost: -totalRefundCost, // Negative cost (Inventory cost is recovered)
                profit: refundAmount - totalRefundCost, // Recalculated profit from return
                paymentMethod: 'Refund',
                customerName: sale.customerName || 'N/A',
                customerPhone: sale.customerPhone || 'N/A',
                items: refundItems.map(item => ({ ...item, lineTotal: -item.lineTotal })), // Negative line totals
                type: 'Refund',
                originalInvoice: originalInvoiceId 
            };
            
            sales.push(newRefund);
            saveAllData();
            
            // Close modal and refresh screens
            const returnModalElement = document.getElementById('returnModal');
            const returnModal = bootstrap.Modal.getInstance(returnModalElement);
            returnModal.hide();
            
            alert(`Refund completed! Refund Invoice ID: ${refundInvoiceId}. Amount: ${refundAmount.toFixed(2)} PKR.`);
            
            // Clear last sale ID as the last action was a refund
            lastSaleInvoiceId = null;
            updatePrintButtonVisibility();


            // Re-render relevant screens
            renderInventory(); 
            searchProduct();
            renderDashboard();
        }

        // --- PURCHASE LOGIC (Stock In) ---
        
        function handleAddPurchase(event) {
            event.preventDefault();
            
            const supplier = document.getElementById('purchase-supplier')?.value;
            const date = document.getElementById('purchase-date')?.value;
            const invoiceNo = document.getElementById('purchase-invoice-no')?.value.trim();
            const total = parseFloat(document.getElementById('purchase-total')?.value);
            const fullDate = new Date().toISOString();

            if (!supplier) {
                alert("Please select a supplier.");
                return;
            }

            const newPurchase = {
                id: purchases.length > 0 ? Math.max(...purchases.map(p => p.id)) + 1 : 1,
                date: date,
                fullDate: fullDate,
                invoiceNo: invoiceNo,
                supplier: supplier,
                total: total
            };

            purchases.push(newPurchase);
            saveAllData();
            renderPurchaseHistory();
            document.getElementById('add-purchase-form').reset();
            alert(`Purchase from ${supplier} (Invoice ${invoiceNo}) recorded.`);
        }

        function renderPurchaseHistory() {
            const tableBody = document.getElementById('purchase-table')?.querySelector('tbody');
            if (!tableBody) return; 
            
            tableBody.innerHTML = ''; 
            const sortedPurchases = [...purchases].sort((a, b) => new Date(b.fullDate) - new Date(a.fullDate));

            sortedPurchases.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.date}</td>
                    <td>${item.invoiceNo}</td>
                    <td>${item.supplier}</td>
                    <td>${item.total.toFixed(2)}</td>
                    <td><button onclick="deletePurchase(${item.id})" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button></td>
                `;
            });
        }

        function deletePurchase(id) {
            if (confirm("Are you sure you want to delete this purchase record?")) {
                purchases = purchases.filter(item => item.id !== id);
                saveAllData();
                renderPurchaseHistory();
                renderDashboard();
            }
        }

        // --- EXPENSE LOGIC ---

        function handleAddExpense(event) {
            event.preventDefault();

            const category = document.getElementById('expense-category')?.value;
            const date = document.getElementById('expense-date')?.value;
            const amount = parseFloat(document.getElementById('expense-amount')?.value);
            const description = document.getElementById('expense-description')?.value.trim();
            const fullDate = new Date().toISOString();

            if (!category) {
                alert("Please select an expense category.");
                return;
            }

            const newExpense = {
                id: expenses.length > 0 ? Math.max(...expenses.map(e => e.id)) + 1 : 1,
                date: date,
                fullDate: fullDate,
                category: category,
                amount: amount,
                description: description
            };

            expenses.push(newExpense);
            saveAllData();
            renderExpenseHistory();
            document.getElementById('add-expense-form').reset();
            alert(`Expense (${category}) of ${amount.toFixed(2)} PKR recorded.`);
            renderDashboard();
        }

        function renderExpenseHistory() {
            const tableBody = document.getElementById('expense-table')?.querySelector('tbody');
            if (!tableBody) return; 
            
            tableBody.innerHTML = ''; 
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.fullDate) - new Date(a.fullDate));

            sortedExpenses.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.date}</td>
                    <td>${item.category}</td>
                    <td>${item.amount.toFixed(2)}</td>
                    <td>${item.description}</td>
                    <td><button onclick="deleteExpense(${item.id})" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button></td>
                `;
            });
        }

        function deleteExpense(id) {
            if (confirm("Are you sure you want to delete this expense record?")) {
                expenses = expenses.filter(item => item.id !== id);
                saveAllData();
                renderExpenseHistory();
                renderDashboard();
            }
        }


        // --- REPORT LOGIC ---

        let currentReportType = 'sales-report';

        function applyReportFilter() {
            currentFilterStartDate = document.getElementById('report-start-date').value;
            currentFilterEndDate = document.getElementById('report-end-date').value;
            
            if (!currentFilterStartDate || !currentFilterEndDate) {
                alert("Please select both start and end dates.");
                return;
            }
            
            renderReports(currentReportType);
        }

        function renderReports(reportType) {
            currentReportType = reportType;
            const contentDiv = document.getElementById('report-content');
            
            // Update active button style
            document.querySelectorAll('.report-btn').forEach(btn => btn.classList.remove('active-report'));
            document.querySelector(`.report-tabs button[onclick="renderReports('${reportType}')"]`)?.classList.add('active-report');


            if (!currentFilterStartDate || !currentFilterEndDate) {
                contentDiv.innerHTML = '<p class="alert alert-warning">Please apply a date filter first.</p>';
                return;
            }

            // Filter data based on selected range
            const filteredSales = sales.filter(s => dateInRange(s.date, currentFilterStartDate, currentFilterEndDate));
            
            let html = `<h4>Report: ${reportType.replace('-', ' ').toUpperCase()} (From ${currentFilterStartDate} to ${currentFilterEndDate})</h4>`;
            html += `<button class="btn btn-sm btn-secondary float-end no-print" onclick="window.print()"><i class="fas fa-print"></i> Print Report</button>`;
            
            if (reportType === 'sales-report') {
                let totalRevenue = 0;
                let totalRefund = 0;

                html += `<div class="table-responsive"><table class="table table-bordered table-striped table-sm mt-3">
                    <thead class="table-danger"><tr><th>Invoice ID</th><th>Date</th><th>Type</th><th>Total (PKR)</th><th>Customer</th><th>Details</th></tr></thead><tbody>`;

                filteredSales.sort((a, b) => new Date(b.fullDate) - new Date(a.fullDate)).forEach(sale => {
                    const typeBadge = sale.type === 'Refund' ? '<span class="badge bg-danger">Refund</span>' : '<span class="badge bg-success">Sale</span>';
                    const amountDisplay = Math.abs(sale.total).toFixed(2);
                    
                    if (sale.type === 'Sale') totalRevenue += sale.total;
                    if (sale.type === 'Refund') totalRefund += Math.abs(sale.total);

                    html += `<tr>
                        <td>${sale.invoice}</td>
                        <td>${sale.date}</td>
                        <td>${typeBadge}</td>
                        <td class="${sale.type === 'Refund' ? 'text-danger fw-bold' : 'text-success fw-bold'}">${amountDisplay}</td>
                        <td>${sale.customerName || 'N/A'}</td>
                        <td><button class="btn btn-sm btn-info" onclick="alert('Items: ' + JSON.stringify(sales.find(s => s.invoice === ${sale.invoice}).items, null, 2))"><i class="fas fa-info-circle"></i></button></td>
                    </tr>`;
                });
                
                html += `</tbody></table></div>`;
                html += `<div class="alert alert-primary mt-3">
                    <strong>SUMMARY:</strong> 
                    Total Sales Revenue: ${totalRevenue.toFixed(2)} PKR | 
                    Total Refunds: ${totalRefund.toFixed(2)} PKR |
                    Net Revenue: ${(totalRevenue - totalRefund).toFixed(2)} PKR
                </div>`;

            } else if (reportType === 'profit-report') {
                let totalGrossProfit = 0;
                let totalExpenses = 0;
                let totalRefundProfitAdjustment = 0; // Negative profit from refunds

                // Calculate Total Gross Profit from sales (Sale Type only)
                filteredSales.forEach(sale => {
                    totalGrossProfit += sale.profit;
                });
                
                // Calculate Total Expenses
                const filteredExpenses = expenses.filter(e => dateInRange(e.date, currentFilterStartDate, currentFilterEndDate));
                filteredExpenses.forEach(exp => {
                    totalExpenses += exp.amount;
                });

                const netProfit = totalGrossProfit - totalExpenses;

                html += `
                    <div class="row g-4 mt-3">
                        <div class="col-md-4"><div class="card bg-success text-white p-3"><h5>Gross Profit from Sales/Refunds</h5><h2 class="display-6">${totalGrossProfit.toFixed(2)} PKR</h2></div></div>
                        <div class="col-md-4"><div class="card bg-danger text-white p-3"><h5>Total Operating Expenses</h5><h2 class="display-6">${totalExpenses.toFixed(2)} PKR</h2></div></div>
                        <div class="col-md-4"><div class="card bg-primary text-white p-3"><h5>Net Profit (Gross - Expenses)</h5><h2 class="display-6">${netProfit.toFixed(2)} PKR</h2></div></div>
                    </div>
                `;

                html += `<h5 class="mt-4">Expense Details</h5>
                    <div class="table-responsive"><table class="table table-bordered table-striped table-sm">
                    <thead class="table-danger"><tr><th>Date</th><th>Category</th><th>Amount (PKR)</th><th>Description</th></tr></thead><tbody>`;
                
                filteredExpenses.forEach(exp => {
                    html += `<tr><td>${exp.date}</td><td>${exp.category}</td><td>${exp.amount.toFixed(2)}</td><td>${exp.description}</td></tr>`;
                });

                html += `</tbody></table></div>`;

            } else if (reportType === 'expiry-report') {
                const today = new Date(new Date().toISOString().split('T')[0]);
                const upcomingDate = new Date();
                upcomingDate.setDate(today.getDate() + 90); // Next 90 days

                const expiringSoon = inventory.filter(item => {
                    const expiry = new Date(item.expiry);
                    return expiry > today && expiry <= upcomingDate;
                }).sort((a, b) => new Date(a.expiry) - new Date(b.expiry));

                const expired = inventory.filter(item => new Date(item.expiry) < today);

                html += `<h5 class="mt-3 text-danger"><i class="fas fa-exclamation-triangle"></i> Expired Stock (Count: ${expired.length})</h5>`;
                if (expired.length > 0) {
                    html += `<div class="table-responsive"><table class="table table-bordered table-sm">
                        <thead class="table-dark"><tr><th>Name</th><th>Batch No.</th><th>Expiry Date</th><th>Stock</th><th>Cost Value</th></tr></thead><tbody>`;
                    expired.forEach(item => {
                        html += `<tr class="expired-row">
                            <td>${item.name}</td><td>${item.batch}</td><td>${item.expiry}</td><td>${item.stock}</td><td>${(item.stock * item.cost).toFixed(2)}</td>
                        </tr>`;
                    });
                    html += `</tbody></table></div>`;
                } else {
                    html += '<p class="alert alert-info">No expired stock found.</p>';
                }


                html += `<h5 class="mt-5 text-warning"><i class="fas fa-calendar-alt"></i> Expiring within 90 Days (Count: ${expiringSoon.length})</h5>`;
                if (expiringSoon.length > 0) {
                     html += `<div class="table-responsive"><table class="table table-bordered table-sm">
                        <thead class="table-dark"><tr><th>Name</th><th>Batch No.</th><th>Expiry Date</th><th>Days Left</th><th>Stock</th></tr></thead><tbody>`;
                    expiringSoon.forEach(item => {
                        const daysLeft = Math.ceil((new Date(item.expiry) - today) / (1000 * 60 * 60 * 24));
                        html += `<tr class="soon-to-expire-row">
                            <td>${item.name}</td><td>${item.batch}</td><td>${item.expiry}</td><td>${daysLeft}</td><td>${item.stock}</td>
                        </tr>`;
                    });
                    html += `</tbody></table></div>`;
                } else {
                    html += '<p class="alert alert-info">No stock expiring in the next 90 days.</p>';
                }
            }

            contentDiv.innerHTML = html;
        }


        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            updateHeldCount();
            
            // Set today's date for purchase and expense screens
            const today = new Date().toISOString().split('T')[0];
            const purchaseDateInput = document.getElementById('purchase-date');
            const expenseDateInput = document.getElementById('expense-date');
            if (purchaseDateInput) purchaseDateInput.value = today;
            if (expenseDateInput) expenseDateInput.value = today;
            
            // Initialize event listeners for form submissions
            document.getElementById('add-product-form')?.addEventListener('submit', handleAddProduct);
            document.getElementById('add-supplier-form')?.addEventListener('submit', handleAddSupplier);
            document.getElementById('add-purchase-form')?.addEventListener('submit', handleAddPurchase);
            document.getElementById('add-expense-form')?.addEventListener('submit', handleAddExpense);
            
            // Initialize screen switch logic
            document.querySelectorAll('.tabs button').forEach(button => {
                button.addEventListener('click', () => {
                    showScreen(button.dataset.target);
                });
            });
            
            document.querySelectorAll('.dashboard-card').forEach(card => {
                card.addEventListener('click', () => {
                    const target = card.dataset.target;
                    if(target) showScreen(target);
                });
            });

            // Initial view
            showScreen('dashboard-screen');
        });

    </script>
    </body>
</html>