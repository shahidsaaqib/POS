<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فارمیسی پی او ایس سسٹم (Supabase مربوط)</title>
    
    <!-- Bootstrap 5 CDN for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* General Styles for RTL (Right-to-Left) */
        body { background-color: #f4f7f6; font-family: 'Noto Sans Arabic', sans-serif; text-align: right; }
        .container-fluid { padding: 0; }
        .main-content { padding: 20px; }
        .tabs button { margin-left: 5px; margin-right: 0; }
        .screen { display: none; padding: 15px; }
        .screen.active { display: block; }
        
        /* POS Specific */
        .pos-sidebar { height: 85vh; overflow-y: auto; background-color: #ffffff; border-left: 1px solid #eee; border-right: none; }
        .cart-section { height: 60vh; overflow-y: auto; }
        .product-tile { cursor: pointer; border: 1px solid #ddd; padding: 10px; margin-bottom: 5px; transition: background-color 0.2s; border-radius: 5px; }
        .product-tile:hover { background-color: #e9ecef; }
        
        /* Dashboard Cards */
        .dashboard-card { 
            cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s; 
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .dashboard-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }
        .text-arabic { font-family: 'Noto Sans Arabic', sans-serif; }
    </style>
</head>
<body>

<!-- =================================================================
    --- 1. SUPABASE CONFIGURATION (Must be updated) ---
    ================================================================= -->
<script>
    // ***************************************************************
    // --- اپنا Supabase URL اور Anon Key یہاں تبدیل کریں ---
    // ***************************************************************
    const SUPABASE_URL = 'https://mokfiqrydcqggqirvsfi.supabase.co'; // مثلاً: https://xyz.supabase.co
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1va2ZpcXJ5ZGNxZ2dxaXJ2c2ZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyOTUyMDUsImV4cCI6MjA3Njg3MTIwNX0._ELpBK40CuViBoudIaT7hFefYQ5fGNJKWFYb9Ypu3k0'; // مثلاً: eyJhbGciOiJIUzI1Ni...

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

<!-- =================================================================
    --- 2. NAVIGATION AND MAIN LAYOUT (Tabs) ---
    ================================================================= -->
<div class="container-fluid">
    <div class="row bg-white shadow-sm p-3 mb-3">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h4 class="mb-0 text-primary"><i class="fas fa-pills"></i> فارمیسی پی او ایس</h4>
            <div class="tabs">
                <button class="btn btn-primary" data-target="dashboard-screen"><i class="fas fa-tachometer-alt"></i> ڈیش بورڈ</button>
                <button class="btn btn-outline-primary" data-target="pos-screen"><i class="fas fa-cash-register"></i> فروخت (POS)</button>
                <button class="btn btn-outline-primary" data-target="stock-screen"><i class="fas fa-box"></i> سٹاک</button>
                <button class="btn btn-outline-primary" data-target="purchases-screen"><i class="fas fa-shopping-basket"></i> خریداری</button>
                <button class="btn btn-outline-primary" data-target="suppliers-screen"><i class="fas fa-truck"></i> سپلائرز</button>
                <button class="btn btn-outline-primary" data-target="expenses-screen"><i class="fas fa-money-bill-wave"></i> اخراجات</button>
                <button class="btn btn-outline-primary" data-target="reports-screen"><i class="fas fa-chart-line"></i> رپورٹیں</button>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <!-- =================================================================
            --- 3. SCREEN DEFINITIONS (Dashboard, POS, Stock, etc.) ---
            ================================================================= -->
        
        <!-- ڈیش بورڈ سکرین -->
        <div id="dashboard-screen" class="screen active">
            <h2>ڈیش بورڈ - خلاصہ</h2>
            <p class="text-secondary">فوری کارروائیاں اور اہم معلومات</p>
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-success text-white dashboard-card" data-target="pos-screen">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-cash-register"></i> نئی فروخت</h5>
                            <p class="card-text">فوری بل بنائیں</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white dashboard-card" data-target="stock-screen">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-box"></i> سٹاک کا جائزہ</h5>
                            <p class="card-text">تمام سٹاک اور مقدار</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-dark dashboard-card" data-target="reports-screen">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-chart-bar"></i> آج کی رپورٹ</h5>
                            <p class="card-text">آج کی فروخت کا تجزیہ</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white dashboard-card" data-target="stock-screen">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-exclamation-triangle"></i> اِختتام پذیر سٹاک</h5>
                            <p class="card-text">جلد اِکسپائر ہونے والی مصنوعات</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Content: Low Stock & Expiring Stock -->
            <div id="dashboard-content" class="row">
                <!-- Data will be inserted here by renderDashboard() -->
            </div>
        </div>

        <!-- پی او ایس سکرین (فروخت) -->
        <div id="pos-screen" class="screen">
            <div class="row">
                <!-- پروڈکٹ لسٹ (بائیں طرف) -->
                <div class="col-md-8">
                    <h2>فروخت (POS)</h2>
                    <input type="text" id="pos-search" class="form-control mb-3" placeholder="پروڈکٹ کا نام یا بیچ نمبر سے تلاش کریں...">
                    <div id="product-list" class="row" style="height: 75vh; overflow-y: auto;">
                        <!-- Product tiles will be inserted here -->
                    </div>
                </div>

                <!-- کارٹ اور ادائیگی (دائیں طرف) -->
                <div class="col-md-4 pos-sidebar p-3">
                    <h4 class="mb-3">کارٹ</h4>
                    <div id="cart-section" class="cart-section mb-3">
                        <ul id="cart-list" class="list-group">
                            <!-- Cart items will be inserted here -->
                        </ul>
                    </div>

                    <div class="border-top pt-3">
                        <h5 class="d-flex justify-content-between">
                            <span>کل رقم (Total):</span>
                            <span id="cart-total" class="text-primary fs-4">0.00</span>
                        </h5>
                        <button class="btn btn-success w-100 mt-3" onclick="processSale()"><i class="fas fa-check-circle"></i> فروخت مکمل کریں</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- سٹاک سکرین -->
        <div id="stock-screen" class="screen">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>سٹاک کا انتظام</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal"><i class="fas fa-plus"></i> پروڈکٹ شامل کریں</button>
            </div>
            <div id="stock-content">
                <!-- Stock table will be inserted here -->
            </div>
        </div>

        <!-- خریداری سکرین -->
        <div id="purchases-screen" class="screen">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>خریداری کی تفصیلات</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPurchaseModal"><i class="fas fa-plus"></i> خریداری شامل کریں</button>
            </div>
            <div id="purchases-content">
                <!-- Purchases table will be inserted here -->
            </div>
        </div>

        <!-- سپلائرز سکرین -->
        <div id="suppliers-screen" class="screen">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>سپلائرز کا انتظام</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSupplierModal"><i class="fas fa-plus"></i> سپلائر شامل کریں</button>
            </div>
            <div id="suppliers-content">
                <!-- Suppliers table will be inserted here -->
            </div>
        </div>
        
        <!-- اخراجات سکرین -->
        <div id="expenses-screen" class="screen">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>اخراجات</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addExpenseModal"><i class="fas fa-plus"></i> اخراجات شامل کریں</button>
            </div>
            <div id="expenses-content">
                <!-- Expenses table will be inserted here -->
            </div>
        </div>
        
        <!-- رپورٹیں سکرین -->
        <div id="reports-screen" class="screen">
            <h2>رپورٹیں اور تجزیہ</h2>
            <div id="reports-content">
                <p class="alert alert-info">یہاں آپ فروخت، خریداری اور منافع کی رپورٹیں دیکھ سکتے ہیں۔</p>
            </div>
        </div>
        
    </div>
</div>

<!-- =================================================================
    --- 4. MODALS (Pop-ups for Adding Data) ---
    ================================================================= -->

<!-- پروڈکٹ شامل کریں ماڈل -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true" dir="rtl">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="add-product-form">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">نئی پروڈکٹ شامل کریں</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بند کریں"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="productName" class="form-label">پروڈکٹ کا نام</label>
                        <input type="text" class="form-control" id="productName" required>
                    </div>
                    <div class="mb-3">
                        <label for="productUnit" class="form-label">یونٹ (مثلاً: گولی، شیشی)</label>
                        <input type="text" class="form-control" id="productUnit" required>
                    </div>
                    <div class="mb-3">
                        <label for="productLowStock" class="form-label">کم سٹاک کی تنبیہ کی حد</label>
                        <input type="number" class="form-control" id="productLowStock" value="10" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بند کریں</button>
                    <button type="submit" class="btn btn-primary">محفوظ کریں</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- سپلائر شامل کریں ماڈل -->
<div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="addSupplierModalLabel" aria-hidden="true" dir="rtl">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="add-supplier-form">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSupplierModalLabel">نیا سپلائر شامل کریں</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بند کریں"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="supplierName" class="form-label">سپلائر کا نام</label>
                        <input type="text" class="form-control" id="supplierName" required>
                    </div>
                    <div class="mb-3">
                        <label for="supplierContact" class="form-label">رابطہ نمبر</label>
                        <input type="text" class="form-control" id="supplierContact">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بند کریں</button>
                    <button type="submit" class="btn btn-primary">محفوظ کریں</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- خریداری شامل کریں ماڈل -->
<div class="modal fade" id="addPurchaseModal" tabindex="-1" aria-labelledby="addPurchaseModalLabel" aria-hidden="true" dir="rtl">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="add-purchase-form">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPurchaseModalLabel">خریداری شامل کریں (سٹاک میں اضافہ)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بند کریں"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="purchaseProduct" class="form-label">پروڈکٹ</label>
                        <select class="form-select" id="purchaseProduct" required>
                            <!-- Options filled by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="purchaseSupplier" class="form-label">سپلائر</label>
                        <select class="form-select" id="purchaseSupplier" required>
                            <!-- Options filled by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="purchaseBatch" class="form-label">بیچ نمبر</label>
                        <input type="text" class="form-control" id="purchaseBatch" required>
                    </div>
                    <div class="mb-3">
                        <label for="purchaseQty" class="form-label">مقدار (Quantity)</label>
                        <input type="number" class="form-control" id="purchaseQty" required>
                    </div>
                    <div class="mb-3">
                        <label for="purchaseCost" class="form-label">یونٹ قیمت خرید (Cost Price)</label>
                        <input type="number" step="0.01" class="form-control" id="purchaseCost" required>
                    </div>
                    <div class="mb-3">
                        <label for="purchaseSell" class="form-label">یونٹ قیمت فروخت (Selling Price)</label>
                        <input type="number" step="0.01" class="form-control" id="purchaseSell" required>
                    </div>
                    <div class="mb-3">
                        <label for="purchaseExpiry" class="form-label">تاریخِ اِختتام (Expiry Date)</label>
                        <input type="date" class="form-control" id="purchaseExpiry" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بند کریں</button>
                    <button type="submit" class="btn btn-primary">خریداری محفوظ کریں</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- اخراجات شامل کریں ماڈل -->
<div class="modal fade" id="addExpenseModal" tabindex="-1" aria-labelledby="addExpenseModalLabel" aria-hidden="true" dir="rtl">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="add-expense-form">
                <div class="modal-header">
                    <h5 class="modal-title" id="addExpenseModalLabel">نیا خرچہ شامل کریں</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بند کریں"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="expenseDescription" class="form-label">تفصیل</label>
                        <input type="text" class="form-control" id="expenseDescription" required>
                    </div>
                    <div class="mb-3">
                        <label for="expenseAmount" class="form-label">رقم (Amount)</label>
                        <input type="number" step="0.01" class="form-control" id="expenseAmount" required>
                    </div>
                    <div class="mb-3">
                        <label for="expenseCategory" class="form-label">قسم (Category)</label>
                        <select class="form-select" id="expenseCategory">
                            <option value="rent">کرایہ</option>
                            <option value="salary">تنخواہ</option>
                            <option value="utility">یوٹیلٹی بلز</option>
                            <option value="misc">متفرق (Miscellaneous)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بند کریں</button>
                    <button type="submit" class="btn btn-primary">خرچہ محفوظ کریں</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- =================================================================
    --- 5. JAVASCRIPT LOGIC (Data, CRUD, Rendering) ---
    ================================================================= -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let appData = {
        products: [],
        suppliers: [],
        stock: [],
        purchases: [],
        expenses: [],
        sales: []
    };
    let currentCart = [];
    let currentScreen = 'dashboard-screen';

    // Helper to show custom alerts
    function customAlert(message, type = 'success') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show fixed-top mt-2 mx-auto w-50`;
        alertDiv.style.zIndex = 1050;
        alertDiv.setAttribute('role', 'alert');
        alertDiv.innerHTML = `
            <strong>نوٹ:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="بند کریں"></button>
        `;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }

    // =================================================================
    // --- 6. DATA FETCHING AND STORAGE ---
    // =================================================================

    async function fetchData(table) {
        try {
            const { data, error } = await supabase
                .from(table)
                .select('*');
            
            if (error) throw error;
            return data;
        } catch (error) {
            console.error(`Error fetching ${table}:`, error);
            customAlert(`ڈیٹا لوڈ کرنے میں خرابی: ${error.message}`, 'danger');
            return [];
        }
    }

    async function loadData() {
        showLoading(true);
        appData.products = await fetchData('products');
        appData.suppliers = await fetchData('suppliers');
        appData.stock = await fetchData('stock');
        appData.purchases = await fetchData('purchases');
        appData.expenses = await fetchData('expenses');
        appData.sales = await fetchData('sales'); // Assuming 'sales' table for reports
        showLoading(false);
        initPOS(); 
        renderScreen(currentScreen);
    }

    function showLoading(isLoading) {
        // Simple loading indicator logic (can be improved)
        const tabs = document.querySelector('.tabs');
        if (isLoading) {
            tabs.innerHTML = '<span class="text-secondary"><i class="fas fa-spinner fa-spin"></i> ڈیٹا لوڈ ہو رہا ہے...</span>';
        } else {
            // Re-render tabs after loading
            const tabsHtml = `
                <button class="btn btn-primary" data-target="dashboard-screen"><i class="fas fa-tachometer-alt"></i> ڈیش بورڈ</button>
                <button class="btn btn-outline-primary" data-target="pos-screen"><i class="fas fa-cash-register"></i> فروخت (POS)</button>
                <button class="btn btn-outline-primary" data-target="stock-screen"><i class="fas fa-box"></i> سٹاک</button>
                <button class="btn btn-outline-primary" data-target="purchases-screen"><i class="fas fa-shopping-basket"></i> خریداری</button>
                <button class="btn btn-outline-primary" data-target="suppliers-screen"><i class="fas fa-truck"></i> سپلائرز</button>
                <button class="btn btn-outline-primary" data-target="expenses-screen"><i class="fas fa-money-bill-wave"></i> اخراجات</button>
                <button class="btn btn-outline-primary" data-target="reports-screen"><i class="fas fa-chart-line"></i> رپورٹیں</button>
            `;
            tabs.innerHTML = tabsHtml;
            attachTabListeners();
        }
    }

    // =================================================================
    // --- 7. UI SCREEN RENDERING ---
    // =================================================================

    function showScreen(targetId) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(targetId).classList.add('active');
        currentScreen = targetId;
        renderScreen(targetId);
        
        // Update button active state
        document.querySelectorAll('.tabs button').forEach(button => {
            if (button.dataset.target === targetId) {
                button.classList.add('btn-primary');
                button.classList.remove('btn-outline-primary');
            } else {
                button.classList.remove('btn-primary');
                button.classList.add('btn-outline-primary');
            }
        });
    }

    function renderScreen(screenId) {
        switch(screenId) {
            case 'dashboard-screen':
                renderDashboard();
                break;
            case 'pos-screen':
                renderProductTiles(appData.stock);
                renderCart(); // Re-render cart on screen change
                break;
            case 'stock-screen':
                renderStockContent();
                break;
            case 'purchases-screen':
                renderPurchasesContent();
                break;
            case 'suppliers-screen':
                renderSuppliersContent();
                break;
            case 'expenses-screen':
                renderExpensesContent();
                break;
            case 'reports-screen':
                renderReportsContent();
                break;
        }
    }

    // --- Stock Rendering ---
    function renderStockContent() {
        const contentDiv = document.getElementById('stock-content');
        if (!contentDiv) return;

        let html = '<div class="table-responsive"><table class="table table-striped table-hover">';
        html += '<thead class="bg-primary text-white"><tr><th>نام</th><th>بیچ</th><th>مقدار</th><th>خرید قیمت</th><th>فروخت قیمت</th><th>اِختتام تاریخ</th><th>بقیہ دن</th></tr></thead><tbody>';

        appData.stock.forEach(item => {
            const expiryDate = new Date(item.expiry_date);
            const today = new Date();
            const diffTime = expiryDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let rowClass = '';
            if (diffDays <= 90) {
                rowClass = 'table-danger'; // Expiring soon
            } else if (item.quantity <= (appData.products.find(p => p.id === item.product_id)?.low_stock_threshold || 10)) {
                rowClass = 'table-warning'; // Low stock
            }

            // Find product name
            const product = appData.products.find(p => p.id === item.product_id);
            const productName = product ? product.name : 'نامعلوم پروڈکٹ';
            
            html += `<tr class="${rowClass}">
                <td>${productName}</td>
                <td>${item.batch_number}</td>
                <td>${item.quantity}</td>
                <td>${item.cost_price}</td>
                <td>${item.selling_price}</td>
                <td>${item.expiry_date}</td>
                <td>${diffDays >= 0 ? diffDays : 'اِکسپائر'}</td>
            </tr>`;
        });

        html += '</tbody></table></div>';
        contentDiv.innerHTML = html;
    }
    
    // --- Suppliers Rendering ---
    function renderSuppliersContent() {
        const contentDiv = document.getElementById('suppliers-content');
        if (!contentDiv) return;

        let html = '<div class="table-responsive"><table class="table table-striped table-hover">';
        html += '<thead class="bg-primary text-white"><tr><th>نام</th><th>رابطہ نمبر</th><th>شامل کرنے کی تاریخ</th></tr></thead><tbody>';

        appData.suppliers.forEach(item => {
            html += `<tr>
                <td>${item.name}</td>
                <td>${item.contact_number || '-'}</td>
                <td>${new Date(item.created_at).toLocaleDateString('ur-PK')}</td>
            </tr>`;
        });

        html += '</tbody></table></div>';
        contentDiv.innerHTML = html;
        
        populateSupplierSelects(); // Ensure selects are updated
    }
    
    // --- Purchases Rendering ---
    function renderPurchasesContent() {
        const contentDiv = document.getElementById('purchases-content');
        if (!contentDiv) return;

        let html = '<div class="table-responsive"><table class="table table-striped table-hover">';
        html += '<thead class="bg-primary text-white"><tr><th>پروڈکٹ</th><th>سپلائر</th><th>بیچ</th><th>مقدار</th><th>قیمت خرید</th><th>تاریخ</th></tr></thead><tbody>';

        appData.purchases.forEach(item => {
            const product = appData.products.find(p => p.id === item.product_id);
            const supplier = appData.suppliers.find(s => s.id === item.supplier_id);
            
            const productName = product ? product.name : 'نامعلوم پروڈکٹ';
            const supplierName = supplier ? supplier.name : 'نامعلوم سپلائر';
            
            html += `<tr>
                <td>${productName}</td>
                <td>${supplierName}</td>
                <td>${item.batch_number}</td>
                <td>${item.quantity}</td>
                <td>${item.total_cost.toFixed(2)}</td>
                <td>${new Date(item.created_at).toLocaleDateString('ur-PK')}</td>
            </tr>`;
        });

        html += '</tbody></table></div>';
        contentDiv.innerHTML = html;
        
        populatePurchaseSelects(); // Ensure selects are updated
    }
    
    // --- Expenses Rendering ---
    function renderExpensesContent() {
        const contentDiv = document.getElementById('expenses-content');
        if (!contentDiv) return;

        let html = '<div class="table-responsive"><table class="table table-striped table-hover">';
        html += '<thead class="bg-primary text-white"><tr><th>تاریخ</th><th>تفصیل</th><th>رقم</th><th>قسم</th></tr></thead><tbody>';

        appData.expenses.forEach(item => {
            html += `<tr>
                <td>${new Date(item.created_at).toLocaleDateString('ur-PK')}</td>
                <td>${item.description}</td>
                <td>${item.amount.toFixed(2)}</td>
                <td>${item.category}</td>
            </tr>`;
        });

        html += '</tbody></table></div>';
        contentDiv.innerHTML = html;
    }
    
    // --- Reports Rendering ---
    function renderReportsContent() {
        const contentDiv = document.getElementById('reports-content');
        if (!contentDiv) return;

        // Simple profit calculation for demonstration
        const totalSalesRevenue = appData.sales.reduce((sum, sale) => sum + sale.total_price, 0);
        const totalCostOfGoodsSold = appData.sales.reduce((sum, sale) => sum + sale.cost_of_goods_sold, 0);
        const totalExpenses = appData.expenses.reduce((sum, expense) => sum + expense.amount, 0);
        
        const grossProfit = totalSalesRevenue - totalCostOfGoodsSold;
        const netProfit = grossProfit - totalExpenses;
        
        let html = `
            <h3>مالیاتی خلاصہ (Financial Summary)</h3>
            <div class="row">
                <div class="col-md-4">
                    <div class="card text-white bg-success mb-3">
                        <div class="card-header">کل فروخت (Total Revenue)</div>
                        <div class="card-body">
                            <h4 class="card-title">${totalSalesRevenue.toFixed(2)}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-header">مجموعی منافع (Gross Profit)</div>
                        <div class="card-body">
                            <h4 class="card-title">${grossProfit.toFixed(2)}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-warning mb-3">
                        <div class="card-header">خالص منافع (Net Profit)</div>
                        <div class="card-body">
                            <h4 class="card-title">${netProfit.toFixed(2)}</h4>
                        </div>
                    </div>
                </div>
            </div>
            
            <h3>اخراجات کا خلاصہ</h3>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr class="table-secondary"><th>قسم</th><th>کل رقم</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>کل اخراجات</td><td>${totalExpenses.toFixed(2)}</td></tr>
                        <tr><td>تنخواہ</td><td>${appData.expenses.filter(e => e.category === 'salary').reduce((s, e) => s + e.amount, 0).toFixed(2)}</td></tr>
                        <tr><td>کرایہ</td><td>${appData.expenses.filter(e => e.category === 'rent').reduce((s, e) => s + e.amount, 0).toFixed(2)}</td></tr>
                        <tr><td>یوٹیلٹی</td><td>${appData.expenses.filter(e => e.category === 'utility').reduce((s, e) => s + e.amount, 0).toFixed(2)}</td></tr>
                    </tbody>
                </table>
            </div>
        `;
        contentDiv.innerHTML = html;
    }
    
    // --- Dashboard Rendering ---
    function renderDashboard() {
        const contentDiv = document.getElementById('dashboard-content');
        if (!contentDiv) return;

        // 1. Low Stock Alert
        const lowStockProducts = appData.stock.filter(item => {
            const product = appData.products.find(p => p.id === item.product_id);
            return item.quantity <= (product?.low_stock_threshold || 10);
        });

        // 2. Expiring Stock Alert (within 90 days)
        const ninetyDays = 90 * 24 * 60 * 60 * 1000;
        const today = new Date();
        const expiringStock = appData.stock.filter(item => {
            const expiryDate = new Date(item.expiry_date);
            const diffTime = expiryDate - today;
            return diffTime > 0 && diffTime <= ninetyDays;
        });

        let html = '';

        // Low Stock Section
        html += `<div class="col-md-6 mb-4">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark"><i class="fas fa-exclamation-circle"></i> کم سٹاک کی تنبیہات</div>
                <div class="card-body">`;
        if (lowStockProducts.length > 0) {
            html += `<ul class="list-group list-group-flush">`;
            lowStockProducts.forEach(item => {
                const product = appData.products.find(p => p.id === item.product_id);
                html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${product ? product.name : 'نامعلوم'} (${item.batch_number})
                    <span class="badge bg-danger">${item.quantity} بقیہ</span>
                </li>`;
            });
            html += `</ul>`;
        } else {
            html += '<p class="alert alert-success">کوئی کم سٹاک پروڈکٹ نہیں ہے۔</p>';
        }
        html += `</div></div></div>`;

        // Expiring Stock Section
        html += `<div class="col-md-6 mb-4">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white"><i class="fas fa-calendar-times"></i> اِختتام پذیر سٹاک (90 دن میں)</div>
                <div class="card-body">`;
        if (expiringStock.length > 0) {
            html += `<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr><th>پروڈکٹ</th><th>بیچ</th><th>دن بقیہ</th></tr></thead><tbody>`;
            expiringStock.forEach(item => {
                const product = appData.products.find(p => p.id === item.product_id);
                const expiryDate = new Date(item.expiry_date);
                const diffTime = expiryDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                html += `<tr>
                    <td>${product ? product.name : 'نامعلوم'}</td>
                    <td>${item.batch_number}</td>
                    <td><span class="badge bg-danger">${diffDays}</span></td>
                    </tr>`;
            });
            html += `</tbody></table></div>`;
        } else {
            html += '<p class="alert alert-info">اگلے 90 دنوں میں کوئی سٹاک اِکسپائر نہیں ہو رہا۔</p>';
        }
        html += `</div></div></div>`;

        contentDiv.innerHTML = html;
    }

    // --- POS Rendering ---
    function renderProductTiles(stockItems) {
        const listDiv = document.getElementById('product-list');
        if (!listDiv) return;

        listDiv.innerHTML = '';
        const searchInput = document.getElementById('pos-search').value.toLowerCase();

        // Map stock items to their product details and aggregate quantity
        const aggregatedProducts = stockItems.reduce((acc, item) => {
            const product = appData.products.find(p => p.id === item.product_id);
            if (!product) return acc;

            // Check if product or batch matches search
            if (searchInput && 
                !product.name.toLowerCase().includes(searchInput) &&
                !item.batch_number.toLowerCase().includes(searchInput)) {
                return acc;
            }

            // Group by product_id for display, but keep batch info
            if (!acc[product.id]) {
                acc[product.id] = {
                    ...product,
                    total_quantity: 0,
                    batches: []
                };
            }
            acc[product.id].total_quantity += item.quantity;
            acc[product.id].batches.push(item);
            return acc;
        }, {});

        Object.values(aggregatedProducts).forEach(product => {
            const tile = document.createElement('div');
            tile.className = 'col-md-6 col-lg-4 mb-3';
            tile.innerHTML = `
                <div class="product-tile shadow-sm" onclick="showBatchSelector(${product.id})">
                    <h6 class="text-primary">${product.name}</h6>
                    <p class="mb-1">سٹاک: <span class="badge bg-secondary">${product.total_quantity} ${product.unit}</span></p>
                    <p class="mb-0 text-success fw-bold">قیمت: ${product.batches[0].selling_price.toFixed(2)}</p>
                </div>
            `;
            listDiv.appendChild(tile);
        });

        if (Object.keys(aggregatedProducts).length === 0) {
            listDiv.innerHTML = '<p class="alert alert-info m-3">کوئی پروڈکٹ نہیں ملا۔</p>';
        }
    }

    // Event listener for search
    document.getElementById('pos-search')?.addEventListener('input', () => {
        renderProductTiles(appData.stock);
    });

    // Function to show batch selector (simple implementation with prompt for now)
    function showBatchSelector(productId) {
        const productDetails = appData.products.find(p => p.id === productId);
        if (!productDetails) return customAlert('پروڈکٹ کی تفصیلات دستیاب نہیں۔', 'danger');

        const availableBatches = appData.stock.filter(item => item.product_id === productId && item.quantity > 0)
            .sort((a, b) => new Date(a.expiry_date) - new Date(b.expiry_date)); // Sort by expiry date

        if (availableBatches.length === 0) return customAlert('یہ پروڈکٹ سٹاک میں دستیاب نہیں۔', 'warning');

        let message = `**${productDetails.name}** کے لیے بیچ منتخب کریں:\n`;
        availableBatches.forEach((batch, index) => {
            message += `${index + 1}. بیچ: ${batch.batch_number}, مقدار: ${batch.quantity}, قیمت: ${batch.selling_price.toFixed(2)}, اِختتام: ${batch.expiry_date}\n`;
        });
        message += "\n مطلوبہ بیچ نمبر یا انڈیکس درج کریں:";

        // Using prompt for simplicity; in a real app, use a proper modal
        const selection = prompt(message);
        if (!selection) return;

        let selectedBatch;
        if (!isNaN(parseInt(selection)) && parseInt(selection) > 0 && parseInt(selection) <= availableBatches.length) {
            selectedBatch = availableBatches[parseInt(selection) - 1];
        } else {
            selectedBatch = availableBatches.find(b => b.batch_number === selection);
        }

        if (!selectedBatch) return customAlert('غلط بیچ کا اِنتخاب۔', 'danger');

        const qtyInput = prompt(`کتنی مقدار (${selectedBatch.batch_number} بیچ) کی ضرورت ہے؟ زیادہ سے زیادہ ${selectedBatch.quantity}:`, 1);
        const quantity = parseInt(qtyInput);

        if (isNaN(quantity) || quantity <= 0 || quantity > selectedBatch.quantity) {
            return customAlert('غلط مقدار۔', 'danger');
        }

        addToCart(selectedBatch, quantity);
    }

    // --- Cart Management ---
    function addToCart(stockItem, quantity) {
        const existingCartItem = currentCart.find(item => item.stock_id === stockItem.id);
        const product = appData.products.find(p => p.id === stockItem.product_id);

        if (existingCartItem) {
            const newQty = existingCartItem.quantity + quantity;
            if (newQty > stockItem.quantity) {
                 return customAlert(`کارٹ میں شامل کرنے کے لیے کافی سٹاک نہیں ہے۔ بقیہ: ${stockItem.quantity}`, 'warning');
            }
            existingCartItem.quantity = newQty;
            existingCartItem.subtotal = newQty * existingCartItem.selling_price;
        } else {
            currentCart.push({
                stock_id: stockItem.id,
                product_name: product.name,
                batch_number: stockItem.batch_number,
                quantity: quantity,
                selling_price: stockItem.selling_price,
                cost_price: stockItem.cost_price, // Needed for COGS calculation
                subtotal: quantity * stockItem.selling_price
            });
        }
        customAlert(`${quantity}x ${product.name} کارٹ میں شامل کر دیا گیا۔`);
        renderCart();
    }

    function renderCart() {
        const cartList = document.getElementById('cart-list');
        const cartTotalSpan = document.getElementById('cart-total');
        if (!cartList || !cartTotalSpan) return;

        let total = 0;
        cartList.innerHTML = '';

        if (currentCart.length === 0) {
            cartList.innerHTML = '<li class="list-group-item text-secondary">کارٹ خالی ہے۔</li>';
        } else {
            currentCart.forEach((item, index) => {
                total += item.subtotal;
                cartList.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${item.product_name}</strong>
                            <small class="d-block text-muted">(${item.batch_number}) | ${item.selling_price.toFixed(2)} x ${item.quantity}</small>
                        </div>
                        <span class="badge bg-success rounded-pill">${item.subtotal.toFixed(2)}</span>
                        <button class="btn btn-sm btn-danger me-2" onclick="removeFromCart(${index})" title="ہٹائیں"><i class="fas fa-trash"></i></button>
                    </li>
                `;
            });
        }
        
        cartTotalSpan.textContent = total.toFixed(2);
    }

    function removeFromCart(index) {
        const productName = currentCart[index].product_name;
        currentCart.splice(index, 1);
        customAlert(`${productName} کارٹ سے ہٹا دیا گیا ہے۔`);
        renderCart();
    }

    async function processSale() {
        if (currentCart.length === 0) {
            return customAlert('فروخت مکمل کرنے کے لیے کارٹ میں آئٹمز شامل کریں۔', 'warning');
        }

        const confirmSale = window.confirm(`کل رقم: ${document.getElementById('cart-total').textContent}۔ کیا آپ فروخت مکمل کرنا چاہتے ہیں؟`);
        
        if (!confirmSale) return;

        let totalSalePrice = 0;
        let totalCostOfGoodsSold = 0;
        let saleItems = [];
        let stockUpdates = [];

        for (const item of currentCart) {
            // Calculate item cost of goods sold (COGS)
            const itemCOGS = item.cost_price * item.quantity;
            totalSalePrice += item.subtotal;
            totalCostOfGoodsSold += itemCOGS;

            saleItems.push({
                stock_id: item.stock_id,
                quantity_sold: item.quantity,
                unit_price: item.selling_price,
                unit_cost: item.cost_price,
                subtotal: item.subtotal
            });

            // Prepare stock update
            const currentStock = appData.stock.find(s => s.id === item.stock_id);
            if (currentStock) {
                const newQuantity = currentStock.quantity - item.quantity;
                stockUpdates.push({
                    id: item.stock_id,
                    quantity: newQuantity
                });
            }
        }

        try {
            // 1. Record the main Sale transaction
            const { data: saleData, error: saleError } = await supabase
                .from('sales')
                .insert({
                    total_price: totalSalePrice,
                    cost_of_goods_sold: totalCostOfGoodsSold,
                    items_count: currentCart.length,
                    created_at: new Date().toISOString()
                })
                .select()
                .single();

            if (saleError) throw saleError;
            
            const saleId = saleData.id;

            // 2. Record the detailed Sale Items (Link to the main Sale)
            const detailedSaleItems = saleItems.map(item => ({...item, sale_id: saleId}));
            const { error: itemsError } = await supabase
                .from('sale_items') // Assuming a 'sale_items' table
                .insert(detailedSaleItems);

            if (itemsError) throw itemsError;

            // 3. Update the Stock quantities
            const updatePromises = stockUpdates.map(update => 
                supabase.from('stock').update({ quantity: update.quantity }).eq('id', update.id)
            );
            await Promise.all(updatePromises);

            customAlert('فروخت کامیابی سے مکمل ہو گئی۔');
            
            // Reload data and reset cart
            currentCart = [];
            await loadData(); // Reload all data to reflect new stock/sales
            renderScreen('pos-screen');

        } catch (error) {
            console.error('Sale Processing Error:', error);
            customAlert(`فروخت مکمل کرنے میں خرابی: ${error.message}`, 'danger');
        }
    }

    // =================================================================
    // --- 8. CRUD HANDLERS (Create operations) ---
    // =================================================================
    
    // --- Add Product ---
    async function handleAddProduct(e) {
        e.preventDefault();
        const name = document.getElementById('productName').value;
        const unit = document.getElementById('productUnit').value;
        const lowStock = parseInt(document.getElementById('productLowStock').value);
        
        try {
            const { error } = await supabase.from('products').insert({
                name: name,
                unit: unit,
                low_stock_threshold: lowStock
            });
            
            if (error) throw error;
            customAlert(`پروڈکٹ '${name}' کامیابی سے شامل کر دی گئی۔`);
            
            // Close modal and reload data
            bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
            await loadData();
            renderScreen('stock-screen');
        } catch (error) {
            customAlert(`پروڈکٹ شامل کرنے میں خرابی: ${error.message}`, 'danger');
        }
    }
    
    // --- Add Supplier ---
    async function handleAddSupplier(e) {
        e.preventDefault();
        const name = document.getElementById('supplierName').value;
        const contact = document.getElementById('supplierContact').value;
        
        try {
            const { error } = await supabase.from('suppliers').insert({
                name: name,
                contact_number: contact
            });
            
            if (error) throw error;
            customAlert(`سپلائر '${name}' کامیابی سے شامل کر دیا گیا۔`);
            
            bootstrap.Modal.getInstance(document.getElementById('addSupplierModal')).hide();
            await loadData();
            renderScreen('suppliers-screen');
        } catch (error) {
            customAlert(`سپلائر شامل کرنے میں خرابی: ${error.message}`, 'danger');
        }
    }

    // --- Add Purchase (and Stock) ---
    async function handleAddPurchase(e) {
        e.preventDefault();
        const productId = document.getElementById('purchaseProduct').value;
        const supplierId = document.getElementById('purchaseSupplier').value;
        const batchNumber = document.getElementById('purchaseBatch').value;
        const quantity = parseInt(document.getElementById('purchaseQty').value);
        const costPrice = parseFloat(document.getElementById('purchaseCost').value);
        const sellingPrice = parseFloat(document.getElementById('purchaseSell').value);
        const expiryDate = document.getElementById('purchaseExpiry').value;
        
        if (isNaN(quantity) || quantity <= 0 || isNaN(costPrice) || costPrice <= 0 || isNaN(sellingPrice) || sellingPrice <= 0) {
            return customAlert('مقدار اور قیمتیں درست درج کریں۔', 'danger');
        }

        try {
            // 1. Insert into Purchases table
            const { data: purchaseData, error: purchaseError } = await supabase
                .from('purchases')
                .insert({
                    product_id: productId,
                    supplier_id: supplierId,
                    batch_number: batchNumber,
                    quantity: quantity,
                    unit_cost: costPrice,
                    total_cost: quantity * costPrice 
                })
                .select()
                .single();

            if (purchaseError) throw purchaseError;
            
            // 2. Insert or Update Stock table (for simplicity, we assume new stock is always added)
            const { error: stockError } = await supabase
                .from('stock')
                .insert({
                    product_id: productId,
                    batch_number: batchNumber,
                    quantity: quantity,
                    cost_price: costPrice,
                    selling_price: sellingPrice,
                    expiry_date: expiryDate
                });
            
            if (stockError) throw stockError;

            customAlert('خریداری اور سٹاک کامیابی سے شامل کر دیا گیا۔');
            
            bootstrap.Modal.getInstance(document.getElementById('addPurchaseModal')).hide();
            await loadData();
            renderScreen('purchases-screen');
        } catch (error) {
            console.error('Purchase/Stock Error:', error);
            customAlert(`خریداری شامل کرنے میں خرابی: ${error.message}`, 'danger');
        }
    }

    // --- Add Expense ---
    async function handleAddExpense(e) {
        e.preventDefault();
        const description = document.getElementById('expenseDescription').value;
        const amount = parseFloat(document.getElementById('expenseAmount').value);
        const category = document.getElementById('expenseCategory').value;
        
        if (isNaN(amount) || amount <= 0) {
            return customAlert('رقم درست درج کریں۔', 'danger');
        }
        
        try {
            const { error } = await supabase.from('expenses').insert({
                description: description,
                amount: amount,
                category: category
            });
            
            if (error) throw error;
            customAlert(`خرچہ کامیابی سے شامل کر دیا گیا۔`);
            
            bootstrap.Modal.getInstance(document.getElementById('addExpenseModal')).hide();
            await loadData();
            renderScreen('expenses-screen');
        } catch (error) {
            customAlert(`خرچہ شامل کرنے میں خرابی: ${error.message}`, 'danger');
        }
    }


    // =================================================================
    // --- 9. UTILITIES (Select Populators) ---
    // =================================================================
    
    function populatePurchaseSelects() {
        const productSelect = document.getElementById('purchaseProduct');
        const supplierSelect = document.getElementById('purchaseSupplier');

        // Clear previous options
        productSelect.innerHTML = '<option value="">پروڈکٹ منتخب کریں</option>';
        supplierSelect.innerHTML = '<option value="">سپلائر منتخب کریں</option>';

        // Populate Products
        appData.products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = product.name;
            productSelect.appendChild(option);
        });

        // Populate Suppliers
        appData.suppliers.forEach(supplier => {
            const option = document.createElement('option');
            option.value = supplier.id;
            option.textContent = supplier.name;
            supplierSelect.appendChild(option);
        });
    }

    // =================================================================
    // --- 10. INITIALIZATION & EVENT LISTENERS ---
    // =================================================================
    
    function attachTabListeners() {
        document.querySelectorAll('.tabs button').forEach(button => {
            button.removeEventListener('click', tabClickHandler); // Remove previous listeners
            button.addEventListener('click', tabClickHandler);
        });
        document.querySelectorAll('.dashboard-card').forEach(card => {
            card.removeEventListener('click', cardClickHandler); // Remove previous listeners
            card.addEventListener('click', cardClickHandler);
        });
    }
    
    function tabClickHandler() {
        showScreen(this.dataset.target);
    }
    
    function cardClickHandler() {
        const target = this.dataset.target;
        if(target) showScreen(target);
    }
    
    function initPOS() {
        // This runs after data is loaded for the first time
        
        // Populate selects for modals
        populatePurchaseSelects(); 
        
        // Initial POS screen rendering (tiles)
        renderProductTiles(appData.stock);
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Load data and then initialize POS features
        loadData();
        
        // --- Form Submission Listeners ---
        document.getElementById('add-product-form')?.addEventListener('submit', handleAddProduct);
        document.getElementById('add-supplier-form')?.addEventListener('submit', handleAddSupplier);
        document.getElementById('add-purchase-form')?.addEventListener('submit', handleAddPurchase);
        document.getElementById('add-expense-form')?.addEventListener('submit', handleAddExpense);
        
        // --- Navigation Listeners ---
        // Attaching initial listeners
        attachTabListeners();
        
        // Ensure initial screen is shown
        showScreen(currentScreen);
    });

</script>

</body>
</html>
