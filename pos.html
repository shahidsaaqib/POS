<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PHARMACY POS - SUPABASE BACKEND (Fixed)</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        header { background-color: #343a40; }
        .tabs .btn { background-color: #495057; border: none; color: white; transition: background-color 0.2s; }
        .tabs .btn:hover { background-color: #5a6268; }
        .tabs .btn.active { background-color: #007bff; box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); }
        .screen { display: none; background-color: white; padding: 20px; border-radius: 8px; margin-top: 15px; min-height: 80vh; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
        .screen.active { display: block; }
        .dashboard-card { transition: transform 0.2s; cursor: pointer; }
        .dashboard-card:hover { transform: translateY(-3px); }
        .product-tile { cursor: pointer; border: 1px solid #ccc; transition: all 0.2s; }
        .product-tile:hover { background-color: #e6f7ff; border-color: #007bff; }
        .price-tag { font-size: 1.2rem; font-weight: bold; color: #28a745; }
        .low-stock-row { background-color: #fff3cd; }
        .expired-row { background-color: #f8d7da; color: #721c24; }
        .soon-to-expire-row { background-color: #ffe0b2; }
        .reorder-needed { background-color: #dc3545!important; color: white!important; font-weight: bold; }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 10px; font-family: monospace; font-size: 10pt; }
            .no-print { display: none; }
            .invoice-line { display: flex; justify-content: space-between; }
            .invoice-footer { margin-top: 15px; border-top: 1px dashed black; padding-top: 5px; text-align: center; }
        }
    </style>
</head>
<body>

    <header class="text-white p-3 shadow-sm no-print">
        <h1 class="h3 mb-0">Pharmacy Point of Sale (Supabase Backend) â€” Fixed</h1>
        <div class="tabs mt-2">
            <button class="btn btn-primary active" data-target="dashboard-screen"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
            <button class="btn btn-primary" data-target="pos-screen"><i class="fas fa-cash-register"></i> Sales</button>
            <button class="btn btn-primary" data-target="inventory-screen"><i class="fas fa-boxes"></i> Inventory</button>
            <button class="btn btn-primary" data-target="purchase-screen"><i class="fas fa-truck"></i> Purchases</button>
            <button class="btn btn-primary" data-target="reports-screen"><i class="fas fa-chart-line"></i> Reports</button>
            <button class="btn btn-primary" data-target="expense-screen"><i class="fas fa-wallet"></i> Expenses</button>
        </div>
    </header>

    <main class="container-fluid p-3">
        <!-- Dashboard -->
        <section id="dashboard-screen" class="screen active">
            <h2 class="text-dark mb-4"><i class="fas fa-chart-pie"></i> Business Overview</h2>

            <div class="row mb-4 align-items-center">
                <div class="col-md-3">
                    <label for="dashboard-filter" class="form-label fw-bold">Select Period:</label>
                    <select id="dashboard-filter" class="form-select" onchange="renderDashboard()">
                        <option value="day">Today</option>
                        <option value="week">Last 7 Days</option>
                        <option value="month">This Month</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="col-md-9 text-end">
                    <button class="btn btn-info" onclick="showScreen('purchase-screen')">New Purchase Order</button>
                    <button class="btn btn-danger" onclick="showScreen('expense-screen')">Record New Expense</button>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white dashboard-card shadow">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-hand-holding-usd"></i> Total Revenue (<span id="dashboard-period">Today</span>)</h5>
                            <h1 class="display-5 fw-bold" id="dashboard-sales">0.00 PKR</h1>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white dashboard-card shadow">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-dollar-sign"></i> Net Profit (<span id="dashboard-period-2">Today</span>)</h5>
                            <h1 class="display-5 fw-bold" id="dashboard-profit">0.00 PKR</h1>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white dashboard-card shadow" data-target="inventory-screen">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-truck-loading"></i> Re-Order Needed</h5>
                            <h1 class="display-5 fw-bold" id="dashboard-reorder-needed">0</h1>
                        </div>
                    </div>
                </div>
                 <div class="col-md-3">
                    <div class="card bg-info text-white dashboard-card shadow" data-target="expense-screen">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-minus-circle"></i> Total Expenses (<span id="dashboard-period-3">Today</span>)</h5>
                            <h1 class="display-5 fw-bold" id="dashboard-expenses">0.00 PKR</h1>
                        </div>
                    </div>
                </div>
            </div>

            <h4 class="mt-5 text-secondary">Recent Sales (Today)</h4>
            <div id="dashboard-recent-sales-table" class="table-responsive"></div>
        </section>

        <!-- POS -->
        <section id="pos-screen" class="screen row">
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h5 text-primary">Products</h2>
                    <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#heldSalesModal" onclick="renderHeldSalesList()">
                        <i class="fas fa-pause"></i> Held Sales (<span id="held-count">0</span>)
                    </button>
                </div>

                <input type="text" id="product-search" class="form-control mb-3" placeholder="Search product name or batch..." oninput="searchProduct()">

                <div id="product-tiles-container" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3"></div>
            </div>

            <div class="col-lg-4 border-start ps-4">
                <h2 class="h5 mb-3 text-success" id="cart-title">Cart</h2>

                <div class="table-responsive mb-3" style="max-height: 40vh; overflow-y: auto;">
                    <table class="table table-sm" id="cart-table">
                        <thead>
                            <tr class="table-dark"><th>Item</th><th>Qty</th><th>Total</th><th>X</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="summary-area p-2 border-top">
                    <h5 class="mt-2 text-info">Customer Info</h5>
                    <input type="text" id="customer-name" class="form-control form-control-sm mb-2" placeholder="Customer Name (Optional)">
                    <input type="text" id="customer-phone" class="form-control form-control-sm mb-3" placeholder="Phone (Optional)">

                    <div class="input-group input-group-sm mb-3">
                        <span class="input-group-text">Tax/GST (%)</span>
                        <input type="number" id="tax-percent" class="form-control" value="0" min="0" oninput="calculateTotal()">
                    </div>

                    <p class="d-flex justify-content-between">Subtotal: <span id="subtotal" class="fw-bold">0.00</span> PKR</p>
                    <p class="d-flex justify-content-between text-danger">Tax/GST: <span id="tax-amount" class="fw-bold">0.00</span> PKR</p>

                    <div class="input-group input-group-sm mb-3">
                        <span class="input-group-text">Discount %</span>
                        <input type="number" id="discount" class="form-control" value="0" min="0" oninput="calculateTotal()">
                    </div>

                    <h4 class="d-flex justify-content-between text-danger">Total: <span id="grand-total" class="fw-bold">0.00</span> PKR</h4>

                    <select id="payment-method" class="form-select form-select-sm mb-3">
                        <option value="Cash">Cash</option>
                        <option value="Card">Card</option>
                        <option value="MobilePay">Mobile Pay (e.g., EasyPaisa)</option>
                    </select>

                    <button onclick="finalizeSale()" class="btn btn-success w-100 mt-1 p-2"><i class="fas fa-check-circle"></i> Complete Sale</button>
                    <div class="row mt-2 g-1">
                        <div class="col-6"><button onclick="holdSale()" class="btn btn-warning w-100"><i class="fas fa-pause"></i> Hold</button></div>
                        <div class="col-6"><button onclick="showReturnModal()" class="btn btn-danger w-100"><i class="fas fa-undo-alt"></i> Refund</button></div>
                    </div>
                    <div id="sale-message" class="mt-2 text-center"></div>

                    <button id="print-last-invoice-btn" onclick="printLastInvoice()" class="btn btn-info w-100 mt-2 p-2" style="display:none;">
                        <i class="fas fa-print"></i> Print Last Invoice
                    </button>
                </div>
            </div>
        </section>

        <!-- Inventory -->
        <section id="inventory-screen" class="screen">
            <h2 class="text-secondary"><i class="fas fa-warehouse"></i> Inventory Management</h2>

            <div class="d-flex justify-content-end mb-3">
                <input type="file" id="csv-file-input" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
                <button class="btn btn-info" onclick="document.getElementById('csv-file-input').click();">
                    <i class="fas fa-file-csv"></i> Import CSV Stock
                </button>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-light">Add/Update Stock</div>
                <div class="card-body">
                    <form id="add-product-form" class="row g-3">
                        <div class="col-md-2"><input type="text" id="p-name" class="form-control" placeholder="Name" required></div>
                        <div class="col-md-2"><input type="text" id="p-batch" class="form-control" placeholder="Batch No." required></div>
                        <div class="col-md-2"><input type="date" id="p-expiry" class="form-control" required title="Expiry Date"></div>
                        <div class="col-md-1"><input type="text" id="p-type" class="form-control" placeholder="Type (Tab/Syp)" required></div>
                        <div class="col-md-1"><input type="number" id="p-price" class="form-control" placeholder="Sell Price" required min="1"></div>
                        <div class="col-md-1"><input type="number" id="p-cost" class="form-control" placeholder="Cost Price" required min="1"></div>
                        <div class="col-md-1"><input type="number" id="p-qty" class="form-control" placeholder="Qty" required min="1"></div>
                        <div class="col-md-1"><input type="number" id="p-reorder" class="form-control" placeholder="Re-Order Level" required min="1"></div>
                        <div class="col-md-1">
                            <select id="p-supplier" class="form-select">
                                <option value="">Supplier (Optional)</option>
                            </select>
                        </div>
                        <div class="col-md-1"><button type="submit" class="btn btn-warning w-100"><i class="fas fa-upload"></i> Save</button></div>
                    </form>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="inventory-table">
                    <thead class="table-primary">
                        <tr>
                            <th>ID</th><th>Name</th><th>Batch No.</th><th>Expiry Date</th><th>Type</th><th>Sell Price</th><th>Cost Price (Avg)</th><th>Re-Order Level</th><th>Stock</th><th>Supplier</th><th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <h4 class="mt-5 text-secondary">Supplier Management</h4>
            <form id="add-supplier-form" class="row g-2 mb-3">
                <div class="col-md-3"><input type="text" id="s-name" class="form-control" placeholder="Supplier Name" required></div>
                <div class="col-md-3"><input type="text" id="s-phone" class="form-control" placeholder="Phone/Contact"></div>
                <div class="col-md-2"><button type="submit" class="btn btn-primary w-100"><i class="fas fa-plus"></i> Add Supplier</button></div>
            </form>
            <div id="supplier-list-container"></div>
        </section>

        <!-- Purchase -->
        <section id="purchase-screen" class="screen">
            <h2 class="text-secondary"><i class="fas fa-shopping-basket"></i> Purchase Management (New Stock In)</h2>
            <div class="card mb-4">
                <div class="card-header bg-light">Record New Purchase Invoice</div>
                <div class="card-body">
                    <form id="add-purchase-form" class="row g-3">
                        <div class="col-md-3">
                            <select id="purchase-supplier" class="form-select" required>
                                <option value="">-- Select Supplier --</option>
                            </select>
                        </div>
                        <div class="col-md-2"><input type="date" id="purchase-date" class="form-control" required></div>
                        <div class="col-md-2"><input type="text" id="purchase-invoice-no" class="form-control" placeholder="Invoice No." required></div>
                        <div class="col-md-2"><input type="number" id="purchase-total" class="form-control" placeholder="Total Paid Amount" required min="1"></div>
                        <div class="col-md-2"><button type="submit" class="btn btn-success w-100"><i class="fas fa-save"></i> Record Purchase</button></div>
                    </form>
                </div>
            </div>

            <h4 class="mt-5 text-secondary">Purchase History</h4>
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="purchase-table">
                    <thead class="table-dark">
                        <tr>
                            <th>Date</th><th>Invoice No.</th><th>Supplier</th><th>Total Cost</th><th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Expense -->
        <section id="expense-screen" class="screen">
             <h2 class="text-secondary"><i class="fas fa-money-bill-wave"></i> Expense Tracking</h2>

             <div class="card mb-4">
                <div class="card-header bg-light">Add New Expense</div>
                <div class="card-body">
                    <form id="add-expense-form" class="row g-3">
                        <div class="col-md-3">
                            <select id="expense-category" class="form-select" required>
                                <option value="">-- Select Category --</option>
                                <option value="Rent">Rent</option>
                                <option value="Salary">Salary/Wages</option>
                                <option value="Utility">Utility Bills</option>
                                <option value="OfficeSupply">Office Supplies</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-2"><input type="date" id="expense-date" class="form-control" required></div>
                        <div class="col-md-2"><input type="number" id="expense-amount" class="form-control" placeholder="Amount (PKR)" required min="1"></div>
                        <div class="col-md-4"><input type="text" id="expense-description" class="form-control" placeholder="Description/Note" required></div>
                        <div class="col-md-1"><button type="submit" class="btn btn-danger w-100"><i class="fas fa-plus"></i> Add</button></div>
                    </form>
                </div>
            </div>

            <h4 class="mt-5 text-secondary">Expense History</h4>
             <div class="table-responsive">
                <table class="table table-bordered table-hover" id="expense-table">
                    <thead class="table-dark">
                        <tr>
                            <th>Date</th><th>Category</th><th>Amount (PKR)</th><th>Description</th><th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Reports -->
        <section id="reports-screen" class="screen">
            <h2 class="text-secondary"><i class="fas fa-chart-bar"></i> Business Reports</h2>
            <div class="report-tabs mb-3">
                <button onclick="renderReports('sales-report')" class="btn btn-danger report-btn active-report"><i class="fas fa-history"></i> Sales History</button>
                <button onclick="renderReports('profit-report')" class="btn btn-danger report-btn"><i class="fas fa-money-bill-wave"></i> Profit Report</button>
                <button onclick="renderReports('expiry-report')" class="btn btn-danger report-btn"><i class="fas fa-calendar-times"></i> Expiry Report</button>
            </div>

            <div class="d-flex align-items-center mb-3">
                <label for="report-start-date" class="me-2">Start Date:</label>
                <input type="date" id="report-start-date" class="form-control form-control-sm me-3" style="width: 150px;">
                <label for="report-end-date" class="me-2">End Date:</label>
                <input type="date" id="report-end-date" class="form-control form-control-sm me-3" style="width: 150px;">
                <button onclick="applyReportFilter()" class="btn btn-info btn-sm">Apply Filter</button>
            </div>

            <div id="report-content" class="card p-3 shadow-sm"></div>
        </section>
    </main>

    <div id="print-area"></div>

    <!-- Held Sales Modal -->
    <div class="modal fade" id="heldSalesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Held Sales / Pending Bills</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="held-sales-list"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Return Modal -->
    <div class="modal fade" id="returnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">Process Refund/Return</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Enter the **Invoice ID** to load and process a return.</p>
                    <input type="number" id="return-invoice-id" class="form-control mb-3" placeholder="Invoice ID (e.g., 1001)">
                    <button class="btn btn-info w-100 mb-3" onclick="loadSaleForReturn()">Load Sale</button>

                    <div id="return-details-area"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // --- Supabase config (keep or replace with your own) ---
        const SUPABASE_URL = 'https://mokfiqrydcqggqirvsfi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1va2ZpcXJ5ZGNxZ2dxaXJ2c2ZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyOTUyMDUsImV4cCI6MjA3Njg3MTIwNX0._ELpBK40CuViBoudIaT7hFefYQ5fGNJKWFYb9Ypu3k0';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Table names
        const T_INVENTORY = 'inventory';
        const T_SALES = 'sales';
        const T_HELDSALES = 'held_sales';
        const T_SUPPLIERS = 'suppliers';
        const T_PURCHASES = 'purchases';
        const T_EXPENSES = 'expenses';

        // State
        let inventory = [];
        let sales = [];
        let cart = [];
        let heldSales = [];
        let suppliers = [];
        let purchases = [];
        let expenses = [];
        let lastSaleInvoiceId = null;
        let currentFilterStartDate = null;
        let currentFilterEndDate = null;

        const DUMMY_INVENTORY = [
            { id: 1, name: "Panadol Extra", batch: "P-101", expiry: "2027-05-30", type: "Tab", price: 50.00, cost: 40.00, stock: 150, reorder_level: 20, supplier: "Alpha Pharma" },
            { id: 2, name: "Syp Augmentin", batch: "A-50", expiry: "2026-11-15", type: "Syp", price: 250.00, cost: 200.00, stock: 50, reorder_level: 10, supplier: "Beta Labs" },
        ];
        const DUMMY_SUPPLIERS = [
             { id: 1, name: "Alpha Pharma", phone: "0300-111222" },
             { id: 2, name: "Beta Labs", phone: "0300-999888" },
        ];

        // --- Load initial data ---
        async function loadData() {
            try {
                const { data: invData, error: invError } = await supabaseClient.from(T_INVENTORY).select('*');
                if (invError) throw invError;
                inventory = invData && invData.length > 0 ? invData : DUMMY_INVENTORY;

                const { data: salesData, error: salesError } = await supabaseClient.from(T_SALES).select('*');
                if (salesError) throw salesError;
                sales = salesData || [];

                const { data: supData, error: supError } = await supabaseClient.from(T_SUPPLIERS).select('*');
                if (supError) throw supError;
                suppliers = supData && supData.length > 0 ? supData : DUMMY_SUPPLIERS;

                const { data: purData, error: purError } = await supabaseClient.from(T_PURCHASES).select('*');
                if (purError) throw purError;
                purchases = purData || [];

                const { data: expData, error: expError } = await supabaseClient.from(T_EXPENSES).select('*');
                if (expError) throw expError;
                expenses = expData || [];

                const { data: heldData, error: heldError } = await supabaseClient.from(T_HELDSALES).select('data').limit(1);
                if (heldError) throw heldError;
                heldSales = (heldData && heldData.length > 0) ? (heldData[0].data || []) : [];

                console.log("Data loaded successfully from Supabase.");
            } catch (e) {
                console.error("Critical Error loading data from Supabase:", e);
                alert("Data loading failed! Check console for API errors. Please ensure your Supabase tables exist and RLS is configured.");
            }

            initPOS();
        }

        async function saveHeldSales(showAlert = true) {
            try {
                const { error } = await supabaseClient
                    .from(T_HELDSALES)
                    .upsert({ id: 1, data: heldSales }, { onConflict: 'id' });

                if (error) throw error;
                console.log("Held Sales saved successfully to Supabase.");
                updateHeldCount();
            } catch (e) {
                console.error("Critical Error saving Held Sales:", e);
                if (showAlert) alert("Critical Save Error for Held Sales. Data may not be backed up.");
            }
        }

        function dateInRange(dateStr, startStr, endStr) {
            return dateStr >= startStr && dateStr <= endStr;
        }

        function initPOS() {
            const today = new Date().toISOString().split('T')[0];
            const purchaseDateInput = document.getElementById('purchase-date');
            const expenseDateInput = document.getElementById('expense-date');

            if (purchaseDateInput) purchaseDateInput.value = today;
            if (expenseDateInput) expenseDateInput.value = today;

            updateHeldCount();
            showScreen('dashboard-screen');
            renderInventory();
            populateSupplierDropdowns();
            renderSupplierList();
            renderPurchaseHistory();
            renderExpenseHistory();
            searchProduct();
            renderCart();
        }

        function calculateTotal() {
            let subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const taxPercent = parseFloat(document.getElementById('tax-percent').value) || 0;
            const discountPercent = parseFloat(document.getElementById('discount').value) || 0;

            const subtotalPlusTax = subtotal * (1 + taxPercent / 100);
            const taxAmount = subtotalPlusTax - subtotal;
            let grandTotal = subtotalPlusTax * (1 - discountPercent / 100);

            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('tax-amount').textContent = taxAmount.toFixed(2);
            document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            const screenElement = document.getElementById(screenId);
            if (screenElement) screenElement.classList.add('active');

            document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.tabs button[data-target="${screenId}"]`);
            if (activeBtn) activeBtn.classList.add('active');

            if (screenId === 'inventory-screen') {
                renderInventory();
                renderSupplierList();
                populateSupplierDropdowns();
            } else if (screenId === 'pos-screen') {
                searchProduct();
                renderCart();
                updatePrintButtonVisibility();
            } else if (screenId === 'reports-screen') {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('report-start-date').value = today;
                document.getElementById('report-end-date').value = today;
                currentFilterStartDate = today;
                currentFilterEndDate = today;
                renderReports('sales-report');
            } else if (screenId === 'dashboard-screen') {
                renderDashboard();
            } else if (screenId === 'purchase-screen') {
                renderPurchaseHistory();
                populateSupplierDropdowns();
            } else if (screenId === 'expense-screen') {
                renderExpenseHistory();
            }
        }

        function updateHeldCount() {
            const heldCountElement = document.getElementById('held-count');
            if (heldCountElement) heldCountElement.textContent = heldSales.length;
        }

        function updatePrintButtonVisibility() {
            const btn = document.getElementById('print-last-invoice-btn');
            if (btn) btn.style.display = lastSaleInvoiceId ? 'block' : 'none';
        }

        function printLastInvoice() {
            if (!lastSaleInvoiceId) return alert("No sale has been completed yet to print.");
            const sale = sales.find(s => s.invoice === lastSaleInvoiceId && s.type === 'Sale');
            if (sale) printInvoice(sale);
            else alert("Last sale details not found or it was a refund.");
        }

        function getDateRange(filter) {
            const now = new Date();
            let startDate = new Date();
            let endDate = new Date();
            endDate.setHours(23, 59, 59, 999);

            switch (filter) {
                case 'day': startDate.setHours(0, 0, 0, 0); break;
                case 'week': startDate.setDate(now.getDate() - 7); startDate.setHours(0, 0, 0, 0); break;
                case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); startDate.setHours(0, 0, 0, 0); break;
                case 'all': default: startDate = new Date(0); break;
            }

            return { startDate: startDate.toISOString().split('T')[0], endDate: endDate.toISOString().split('T')[0] };
        }

        function renderDashboard() {
            const filter = document.getElementById('dashboard-filter')?.value || 'day';
            const { startDate, endDate } = getDateRange(filter);

            let totalSales = 0;
            let totalProfit = 0;
            let totalExpenses = 0;
            let periodName = document.getElementById('dashboard-filter').options[document.getElementById('dashboard-filter').selectedIndex].text;

            const filteredSales = sales.filter(sale => dateInRange(sale.date, startDate, endDate));
            filteredSales.forEach(sale => {
                totalSales += sale.total > 0 ? sale.total : 0;
                totalProfit += sale.profit || 0;
            });

            const filteredExpenses = expenses.filter(exp => dateInRange(exp.date, startDate, endDate));
            filteredExpenses.forEach(exp => totalExpenses += exp.amount || 0);

            const netProfitAfterExpense = totalProfit - totalExpenses;

            const reorderNeededCount = inventory.filter(item => {
                const isLowStock = item.stock <= item.reorder_level;
                const isExpired = new Date(item.expiry) < new Date(new Date().toISOString().split('T')[0]);
                return isLowStock || isExpired;
            }).length;

            document.getElementById('dashboard-period').textContent = periodName;
            document.getElementById('dashboard-period-2').textContent = periodName;
            document.getElementById('dashboard-period-3').textContent = periodName;

            document.getElementById('dashboard-sales').textContent = totalSales.toFixed(2) + ' PKR';
            document.getElementById('dashboard-profit').textContent = netProfitAfterExpense.toFixed(2) + ' PKR';
            document.getElementById('dashboard-expenses').textContent = totalExpenses.toFixed(2) + ' PKR';
            document.getElementById('dashboard-reorder-needed').textContent = reorderNeededCount;

            const today = new Date().toISOString().split('T')[0];
            const salesToday = sales.filter(s => s.date === today && s.total > 0);
            const container = document.getElementById('dashboard-recent-sales-table');

            if (salesToday.length === 0) {
                container.innerHTML = '<p class="alert alert-info">No sales recorded today.</p>';
                return;
            }

            let tableHTML = `<table class="table table-striped table-sm"><thead class="table-secondary"><tr><th>Invoice ID</th><th>Time</th><th>Customer</th><th>Total</th></tr></thead><tbody>`;
            salesToday.slice().sort((a, b) => new Date(b.full_date) - new Date(a.full_date)).slice(0, 5).forEach(sale => {
                const time = new Date(sale.full_date).toLocaleTimeString();
                const customerDisplay = sale.customer_name || 'N/A';
                tableHTML += `<tr><td>${sale.invoice}</td><td>${time}</td><td>${customerDisplay}</td><td>${sale.total.toFixed(2)}</td></tr>`;
            });
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function populateSupplierDropdowns() {
            const inventoryDropdown = document.getElementById('p-supplier');
            const purchaseDropdown = document.getElementById('purchase-supplier');

            if (inventoryDropdown) inventoryDropdown.innerHTML = '<option value="">Supplier (Optional)</option>';
            if (purchaseDropdown) purchaseDropdown.innerHTML = '<option value="">-- Select Supplier --</option>';

            suppliers.forEach(supplier => {
                const option = `<option value="${supplier.name}">${supplier.name}</option>`;
                if (inventoryDropdown) inventoryDropdown.innerHTML += option;
                if (purchaseDropdown) purchaseDropdown.innerHTML += option;
            });
        }

        async function handleAddSupplier(event) {
            event.preventDefault();
            const name = document.getElementById('s-name')?.value.trim();
            const phone = document.getElementById('s-phone')?.value.trim();

            if (!name || suppliers.some(s => s.name.toLowerCase() === name.toLowerCase())) {
                alert("Supplier name is required or already exists.");
                return;
            }

            const newSupplier = { name: name, phone: phone };
            const { data, error } = await supabaseClient.from(T_SUPPLIERS).insert(newSupplier).select();

            if (error) {
                console.error('Supabase error:', error);
                alert("Error adding supplier. Check console.");
                return;
            }

            if (data && data.length > 0) {
                 suppliers.push(data[0]);
                 renderSupplierList();
                 populateSupplierDropdowns();
                 document.getElementById('add-supplier-form').reset();
                 alert(`Supplier "${name}" added.`);
            }
        }

        function renderSupplierList() {
            const container = document.getElementById('supplier-list-container');
            if (!container) return;

            const displaySuppliers = suppliers.filter(s => s.name !== 'N/A (CSV Import)');

            if (displaySuppliers.length === 0) {
                container.innerHTML = '<p class="alert alert-warning">No suppliers added yet.</p>';
                return;
            }

            let html = `<table class="table table-sm table-striped"><thead><tr><th>ID</th><th>Name</th><th>Phone</th><th>Action</th></tr></thead><tbody>`;
            displaySuppliers.forEach(s => {
                html += `<tr><td>${s.id}</td><td>${s.name}</td><td>${s.phone}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteSupplier(${s.id})"><i class="fas fa-trash"></i></button></td></tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        async function deleteSupplier(id) {
            if (!confirm("Are you sure you want to delete this supplier?")) return;
            const { error } = await supabaseClient.from(T_SUPPLIERS).delete().eq('id', id);

            if (error) {
                console.error('Supabase error:', error);
                alert("Error deleting supplier. Check console.");
                return;
            }

            suppliers = suppliers.filter(s => s.id !== id);
            renderSupplierList();
            populateSupplierDropdowns();
        }

        function renderInventory() {
            const tableBody = document.getElementById('inventory-table')?.querySelector('tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            const sortedInventory = [...inventory].sort((a, b) => a.name.localeCompare(b.name));
            const today = new Date(new Date().toISOString().split('T')[0]);

            sortedInventory.forEach(item => {
                const row = tableBody.insertRow();
                let rowClass = '';
                const expiryDate = new Date(item.expiry);
                const diffDays = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

                if (expiryDate < today) rowClass = 'expired-row';
                else if (item.stock <= item.reorder_level) rowClass = 'reorder-needed';
                else if (diffDays <= 90 && diffDays > 0) rowClass = 'soon-to-expire-row';
                else if (item.stock < 10) rowClass = 'low-stock-row';

                row.className = rowClass;
                const supplierDisplay = item.supplier || 'N/A';

                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.batch}</td>
                    <td>${item.expiry}</td>
                    <td>${item.type || 'N/A'}</td>
                    <td>${(item.price || 0).toFixed(2)}</td>
                    <td>${(item.cost || 0).toFixed(2)}</td>
                    <td>${item.reorder_level}</td>
                    <td>${item.stock}</td>
                    <td>${supplierDisplay}</td>
                    <td><button onclick="deleteProduct(${item.id})" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button></td>
                `;
            });
        }

        function handleAddProduct(event) {
            event.preventDefault();

            const name = document.getElementById('p-name')?.value.trim();
            const batch = document.getElementById('p-batch')?.value.trim();
            const expiry = document.getElementById('p-expiry')?.value;
            const type = document.getElementById('p-type')?.value.trim();
            const price = parseFloat(document.getElementById('p-price')?.value);
            const cost = parseFloat(document.getElementById('p-cost')?.value);
            const stock = parseInt(document.getElementById('p-qty')?.value);
            const reorderLevel = parseInt(document.getElementById('p-reorder')?.value);
            const supplier = document.getElementById('p-supplier')?.value || 'N/A';

            processInventoryItem({ name, batch, expiry, type, price, cost, stock, reorder_level: reorderLevel, supplier });
            document.getElementById('add-product-form')?.reset();
        }

        async function processInventoryItem({ name, batch, expiry, type, price, cost, stock, reorder_level, supplier }) {
            if (price < cost) { alert(`Error for ${name}: Selling Price must be higher than Cost Price.`); return; }
            if (isNaN(stock) || stock < 0 || isNaN(price) || isNaN(cost)) { alert(`Error for ${name}: Invalid number for stock, price, or cost.`); return; }

            const finalSupplier = supplier || 'N/A';

            const existingItem = inventory.find(item =>
                item.name.toLowerCase() === name.toLowerCase() &&
                item.batch.toLowerCase() === batch.toLowerCase()
            );

            if (existingItem) {
                const oldTotalValue = existingItem.stock * existingItem.cost;
                const newTotalValue = stock * cost;
                const newTotalStock = existingItem.stock + stock;
                const newCost = (oldTotalValue + newTotalValue) / newTotalStock;

                const updatedItem = {
                    stock: newTotalStock,
                    price: price,
                    cost: newCost,
                    type: type,
                    reorder_level: reorder_level,
                    supplier: finalSupplier,
                    expiry: (new Date(expiry) > new Date(existingItem.expiry)) ? expiry : existingItem.expiry
                };

                const { data, error } = await supabaseClient.from(T_INVENTORY).update(updatedItem).eq('id', existingItem.id).select();

                if (error) {
                    console.error('Supabase update error:', error);
                    alert("Error updating product. Check console.");
                    return;
                }

                Object.assign(existingItem, data[0]);
                alert(`Stock for '${name}' (Batch: ${batch}) updated! New Stock: ${existingItem.stock}. New Avg Cost: ${existingItem.cost.toFixed(2)}.`);
            } else {
                const newItem = {
                    name: name, batch: batch, expiry: expiry, type: type, price: price,
                    cost: cost, stock: stock, reorder_level: reorder_level, supplier: finalSupplier
                };

                const { data, error } = await supabaseClient.from(T_INVENTORY).insert(newItem).select();

                if (error) {
                    console.error('Supabase insert error:', error);
                    alert("Error adding product. Check console.");
                    return;
                }

                inventory.push(data[0]);
                alert(`New Item '${name}' added successfully!`);
            }

            renderInventory();
            populateSupplierDropdowns();
        }

        async function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const csvData = e.target.result;
                const lines = csvData.split('\n').filter(line => line.trim() !== '');

                if (lines.length <= 1) {
                    alert("The CSV file is empty or contains only headers.");
                    return;
                }

                const headers = lines[0].toLowerCase().trim().split(',').map(h => h.trim());
                const requiredHeaders = ['name', 'batch', 'expiry', 'type', 'price', 'cost', 'stock', 'reorderlevel', 'supplier'];
                const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));

                if (missingHeaders.length > 0) {
                    alert(`Import Failed: CSV is missing required headers: ${missingHeaders.join(', ')}.`);
                    return;
                }

                let successCount = 0;
                let failCount = 0;
                let newSupplierCount = 0;
                let newItemsToInsert = [];
                let itemsToUpdate = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length < requiredHeaders.length) { failCount++; continue; }

                    const itemData = {};
                    headers.forEach((header, index) => itemData[header] = values[index] ? values[index].trim() : '');

                    try {
                        let supplierName = itemData.supplier || 'N/A';

                        const item = {
                            name: itemData.name,
                            batch: itemData.batch,
                            expiry: itemData.expiry,
                            type: itemData.type,
                            price: parseFloat(itemData.price),
                            cost: parseFloat(itemData.cost),
                            stock: parseInt(itemData.stock),
                            reorder_level: parseInt(itemData.reorderlevel),
                            supplier: supplierName
                        };

                        if (item.supplier !== 'N/A' && !suppliers.some(s => s.name === item.supplier)) {
                            const newSup = { name: item.supplier, phone: 'N/A (CSV Import)' };
                            const { data, error } = await supabaseClient.from(T_SUPPLIERS).insert(newSup).select();
                            if (error) throw error;
                            suppliers.push(data[0]);
                            newSupplierCount++;
                        }

                        const existingItem = inventory.find(i => 
                            i.name.toLowerCase() === item.name.toLowerCase() &&
                            i.batch.toLowerCase() === item.batch.toLowerCase()
                        );

                        if (existingItem) {
                            const oldTotalValue = existingItem.stock * existingItem.cost;
                            const newTotalValue = item.stock * item.cost;
                            const newTotalStock = existingItem.stock + item.stock;
                            const newCost = (oldTotalValue + newTotalValue) / newTotalStock;

                            const updatedRecord = {
                                id: existingItem.id,
                                stock: newTotalStock,
                                price: item.price,
                                cost: newCost,
                                type: item.type,
                                reorder_level: item.reorder_level,
                                supplier: item.supplier,
                                expiry: (new Date(item.expiry) > new Date(existingItem.expiry)) ? item.expiry : existingItem.expiry
                            };

                            Object.assign(existingItem, updatedRecord);
                            itemsToUpdate.push(updatedRecord);
                        } else {
                            newItemsToInsert.push(item);
                        }

                        successCount++;
                    } catch (e) {
                        console.error(`Error processing line ${i + 1}:`, e);
                        failCount++;
                    }
                }

                if (newItemsToInsert.length > 0) {
                    const { data, error } = await supabaseClient.from(T_INVENTORY).insert(newItemsToInsert).select();
                    if (error) console.error("Batch Insert Error:", error);
                    else inventory.push(...data);
                }

                if (itemsToUpdate.length > 0) {
                    const { error } = await supabaseClient.from(T_INVENTORY).upsert(itemsToUpdate, { onConflict: 'id' });
                    if (error) console.error("Batch Update Error:", error);
                }

                renderInventory();
                populateSupplierDropdowns();

                alert(`CSV Import Complete!\n- Success: ${successCount} items processed.\n- Failed: ${failCount} items skipped.\n- New Suppliers Added: ${newSupplierCount}.`);
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        async function deleteProduct(id) {
            if (!confirm("Are you sure you want to delete this item?")) return;
            const { error } = await supabaseClient.from(T_INVENTORY).delete().eq('id', id);

            if (error) {
                console.error('Supabase error:', error);
                alert("Error deleting product. Check console.");
                return;
            }

            inventory = inventory.filter(item => item.id !== id);
            renderInventory();
        }

        function searchProduct() {
            const container = document.getElementById('product-tiles-container');
            const searchInput = document.getElementById('product-search');
            if (!container || !searchInput) return;

            const query = searchInput.value.toLowerCase();
            container.innerHTML = '';

            const today = new Date(new Date().toISOString().split('T')[0]);

            const filtered = inventory.filter(item =>
                item.stock > 0 &&
                new Date(item.expiry) >= today &&
                (item.name.toLowerCase().includes(query) || item.batch.toLowerCase().includes(query))
            );

            if (filtered.length === 0 && inventory.length > 0 && query === "") {
                 container.innerHTML = '<p class="alert alert-warning">No non-expired, in-stock products match the search. Check Inventory screen for details.</p>';
                 return;
            }

            filtered.forEach(item => {
                const isLowStock = item.stock <= item.reorder_level;
                const lowStockBadge = isLowStock ? '<span class="badge bg-danger">Low Stock!</span>' : '';
                const typeDisplay = item.type ? `<small class="text-info">(${item.type})</small>` : '';

                const tile = document.createElement('div');
                tile.className = 'col';
                tile.innerHTML = `
                    <div class="card product-tile p-2 h-100" onclick="addToCart(${item.id}, '${item.batch}')">
                        <h5 class="card-title">${item.name} ${typeDisplay} ${lowStockBadge}</h5>
                        <p class="card-text price-tag">${(item.price || 0).toFixed(2)} PKR</p>
                        <small class="text-muted">Stock: ${item.stock}</small>
                    </div>
                `;
                container.appendChild(tile);
            });
        }

        function addToCart(id, batch) {
            const product = inventory.find(item => item.id === id && item.batch === batch);
            if (!product || product.stock < 1) return alert("Product out of stock!");

            const existingItem = cart.find(item => item.id === product.id && item.batch === product.batch);

            if (existingItem) {
                if (existingItem.qty + 1 > product.stock) {
                    return alert(`Max stock reached for ${product.name}!`);
                }
                existingItem.qty += 1;
            } else {
                cart.push({
                    id: product.id, name: product.name, batch: product.batch,
                    price: product.price, cost: product.cost, stock: product.stock, qty: 1
                });
            }

            renderCart();
        }

        function updateCartQuantity(index, newQty) {
            const qty = parseInt(newQty);
            const item = cart[index];

            if (isNaN(qty) || qty <= 0) return removeFromCart(index);
            if (qty > item.stock) {
                alert(`Cannot add ${qty}. Only ${item.stock} in stock.`);
                document.getElementById('cart-table').rows[index + 1].cells[1].querySelector('input').value = item.qty;
                return;
            }

            item.qty = qty;
            renderCart();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }

        function renderCart(heldCustomerName = '') {
            const tableBody = document.getElementById('cart-table')?.querySelector('tbody');
            const cartTitle = document.getElementById('cart-title');
            if (!tableBody || !cartTitle) return;

            tableBody.innerHTML = '';
            cartTitle.textContent = heldCustomerName ? `Cart (${heldCustomerName})` : 'Cart';

            cart.forEach((item, index) => {
                const total = item.qty * item.price;
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>
                        <input type="number" value="${item.qty}" min="1" max="${item.stock}"
                            onchange="updateCartQuantity(${index}, this.value)" style="width: 50px;">
                    </td>
                    <td>${total.toFixed(2)}</td>
                    <td><button onclick="removeFromCart(${index})" class="btn btn-danger btn-sm p-1">X</button></td>
                `;
            });

            calculateTotal();
        }

        function resetPOSState() {
            cart = [];
            renderCart();
            document.getElementById('discount').value = 0;
            document.getElementById('tax-percent').value = 0;
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-phone').value = '';
            document.getElementById('payment-method').value = 'Cash';
            searchProduct();
        }

        function holdSale() {
            if (cart.length === 0) {
                alert("Cart is empty. Cannot hold an empty sale.");
                return;
            }

            const customerName = document.getElementById('customer-name').value.trim() || `Held Bill #${heldSales.length + 1}`;

            heldSales.push({
                cart: JSON.parse(JSON.stringify(cart)),
                customer_name: customerName,
                customer_phone: document.getElementById('customer-phone').value.trim(),
                tax_percent: parseFloat(document.getElementById('tax-percent').value) || 0,
                discount_percent: parseFloat(document.getElementById('discount').value) || 0,
                held_time: new Date().toLocaleString()
            });

            saveHeldSales();
            resetPOSState();

            const messageDiv = document.getElementById('sale-message');
            messageDiv.innerHTML = `<div class="alert alert-warning mt-2">Sale for <strong>${customerName}</strong> held successfully.</div>`;
            setTimeout(() => messageDiv.innerHTML = '', 3000);
        }

        function renderHeldSalesList() {
            const listDiv = document.getElementById('held-sales-list');
            if (!listDiv) return;

            if (heldSales.length === 0) { listDiv.innerHTML = '<p class="alert alert-info">No pending sales are currently held.</p>'; return; }

            let html = `<ul class="list-group">`;
            heldSales.forEach((sale, index) => {
                const total = calculateHeldTotal(sale);
                html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${sale.customer_name}</strong>
                            <small class="text-muted">(${sale.held_time})</small>
                            <br>Total Items: ${sale.cart.length} | Net Total: ${total.toFixed(2)} PKR
                        </div>
                        <div>
                            <button class="btn btn-sm btn-success me-2" onclick="resumeHeldSale(${index})" data-bs-dismiss="modal">Resume</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteHeldSale(${index})" data-bs-dismiss="modal">Delete</button>
                        </div>
                    </li>
                `;
            });
            html += `</ul>`;
            listDiv.innerHTML = html;
        }

        function calculateHeldTotal(sale) {
            let subtotal = sale.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const subtotalPlusTax = subtotal * (1 + sale.tax_percent / 100);
            let total = subtotalPlusTax * (1 - sale.discount_percent / 100);
            return total < 0 ? 0 : total;
        }

        function resumeHeldSale(index) {
            const heldSale = heldSales[index];

            for (const heldItem of heldSale.cart) {
                const inventoryItem = inventory.find(i => i.id === heldItem.id && i.batch === heldItem.batch);
                if (!inventoryItem || inventoryItem.stock < heldItem.qty) {
                    alert(`Cannot resume sale: Not enough stock for ${heldItem.name} (Batch: ${heldItem.batch}). Available: ${inventoryItem ? inventoryItem.stock : 0}, Needed: ${heldItem.qty}.`);
                    return;
                }
            }

            resetPOSState();
            cart = heldSale.cart;
            document.getElementById('customer-name').value = heldSale.customer_name;
            document.getElementById('customer-phone').value = heldSale.customer_phone;
            document.getElementById('tax-percent').value = heldSale.tax_percent;
            document.getElementById('discount').value = heldSale.discount_percent;

            heldSales.splice(index, 1);
            saveHeldSales();
            renderCart(heldSale.customer_name);
            updateHeldCount();

            const messageDiv = document.getElementById('sale-message');
            messageDiv.innerHTML = `<div class="alert alert-success mt-2">Sale for <strong>${heldSale.customer_name}</strong> resumed.</div>`;
            setTimeout(() => messageDiv.innerHTML = '', 3000);
        }

        function deleteHeldSale(index) {
            if (!confirm("Are you sure you want to permanently delete this held sale?")) return;
            heldSales.splice(index, 1);
            saveHeldSales();
            updateHeldCount();
            alert("Held sale deleted.");
        }

        // --- FINALIZE SALE (with fixed step-by-step stock update) ---
        async function finalizeSale() {
            if (cart.length === 0) { alert("Cart is empty. Please add items to complete the sale."); return; }

            const grandTotalText = document.getElementById('grand-total').textContent;
            const grandTotal = parseFloat(grandTotalText);
            const subtotal = parseFloat(document.getElementById('subtotal').textContent);
            const discountPercent = parseFloat(document.getElementById('discount').value) || 0;
            const taxPercent = parseFloat(document.getElementById('tax-percent').value) || 0;
            const taxAmount = parseFloat(document.getElementById('tax-amount').textContent);
            const paymentMethod = document.getElementById('payment-method').value;
            const customerName = document.getElementById('customer-name').value.trim();
            const customerPhone = document.getElementById('customer-phone').value.trim();

            const invoiceId = sales.length > 0 ? Math.max(...sales.map(s => s.invoice)) + 1 : 1001;
            const fullDate = new Date();
            const saleDate = fullDate.toISOString().split('T')[0];

            let totalCost = 0;
            let soldItems = [];
            let inventoryUpdates = [];

            // Validate availability & prepare updates
            for (const cartItem of cart) {
                const inventoryItem = inventory.find(i => i.id === cartItem.id && i.batch === cartItem.batch);

                if (!inventoryItem || inventoryItem.stock < cartItem.qty) {
                    alert(`Transaction failed: Not enough stock for ${cartItem.name} (Batch: ${cartItem.batch}).`);
                    return;
                }

                // compute new stock locally
                const newStock = inventoryItem.stock - cartItem.qty;
                totalCost += inventoryItem.cost * cartItem.qty;

                soldItems.push({
                    id: cartItem.id,
                    name: cartItem.name,
                    batch: cartItem.batch,
                    qty: cartItem.qty,
                    sell_price: cartItem.price,
                    cost_price: inventoryItem.cost,
                    line_total: cartItem.price * cartItem.qty
                });

                inventoryUpdates.push({
                    id: inventoryItem.id,
                    stock: newStock
                });
            }

            const totalProfit = subtotal - totalCost;

            const newSale = {
                invoice: invoiceId,
                date: saleDate,
                full_date: fullDate.toISOString(),
                total: grandTotal,
                subtotal: subtotal,
                tax_percent: taxPercent,
                tax_amount: taxAmount,
                discount_percent: discountPercent,
                total_cost: totalCost,
                profit: totalProfit,
                payment_method: paymentMethod,
                customer_name: customerName,
                customer_phone: customerPhone,
                items: JSON.stringify(soldItems),
                type: 'Sale'
            };

            // Insert sale first
            const { data: saleData, error: saleError } = await supabaseClient.from(T_SALES).insert(newSale).select();

            if (saleError) {
                console.error('Sale insert error:', saleError);
                alert("Error recording sale. Transaction failed.");
                return;
            }

            // --- âœ… STOCK UPDATE FIXED BLOCK ---
            try {
                for (const item of inventoryUpdates) {
                    const { error: updateError } = await supabaseClient
                        .from(T_INVENTORY)
                        .update({ stock: item.stock })
                        .eq('id', item.id);

                    if (updateError) {
                        console.error(`âŒ Stock update failed for ID ${item.id}:`, updateError);
                        alert(`Stock update failed for ID ${item.id}. Check console.`);
                    } else {
                        console.log(`âœ… Stock updated successfully for ID ${item.id}`);
                        // Also update local inventory array
                        const localItem = inventory.find(i => i.id === item.id);
                        if (localItem) localItem.stock = item.stock;
                    }
                }

                console.log("âœ… All stock updates completed (attempted).");

            } catch (err) {
                console.error("Critical stock update error:", err);
                alert("Critical stock update failure. Please check Supabase permissions or IDs.");
            }

            // Push sale into local array and finalize UI
            sales.push(saleData[0]);
            lastSaleInvoiceId = invoiceId;
            resetPOSState();

            const messageDiv = document.getElementById('sale-message');
            messageDiv.innerHTML = `<div class="alert alert-success mt-2">Sale completed! Invoice ID: <strong>${invoiceId}</strong>. Total: ${grandTotal.toFixed(2)} PKR</div>`;
            setTimeout(() => messageDiv.innerHTML = '', 5000);

            searchProduct();
            renderDashboard();
            updatePrintButtonVisibility();
            renderInventory();
        }

        function printInvoice(sale) {
            const items = typeof sale.items === 'string' ? JSON.parse(sale.items) : sale.items;

            let printContent = `
                <div class="p-3">
                    <h5 style="text-align:center; margin-bottom: 5px;">PHARMACY POS DEMO (SUPABASE)</h5>
                    <p style="text-align:center; font-size: 9pt;">Date: ${new Date(sale.full_date).toLocaleString()}</p>
                    <p style="font-size: 9pt;">Invoice ID: ${sale.invoice}</p>
                    <p style="font-size: 9pt;">Customer: ${sale.customer_name || 'Walk-in'}</p>
                    <p style="font-size: 9pt;">Payment: ${sale.payment_method}</p>
                    <hr style="border-top: 1px dashed black;">
                    
                    <div style="display: flex; font-size: 9pt; font-weight: bold; margin-bottom: 5px;">
                        <span style="width: 50%;">Item</span>
                        <span style="width: 15%; text-align: center;">Qty</span>
                        <span style="width: 35%; text-align: right;">Total</span>
                    </div>
                    <hr style="border-top: 1px dashed black;">
            `;

            items.forEach(item => {
                printContent += `
                    <div style="display: flex; font-size: 9pt; margin-bottom: 3px;">
                        <span style="width: 50%;">#${item.name}</span>
                        <span style="width: 15%; text-align: center;">${item.qty}</span>
                        <span style="width: 35%; text-align: right;">${item.line_total.toFixed(2)}</span>
                    </div>
                `;
            });

            printContent += `
                    <hr style="border-top: 1px dashed black; margin-top: 10px;">
                    <div style="font-size: 9pt; display: flex; justify-content: space-between;">
                        <span>Subtotal:</span>
                        <span style="font-weight: bold;">${sale.subtotal.toFixed(2)} PKR</span>
                    </div>
                    <div style="font-size: 9pt; display: flex; justify-content: space-between;">
                        <span>Tax (${sale.tax_percent}%):</span>
                        <span style="font-weight: bold;">${sale.tax_amount.toFixed(2)} PKR</span>
                    </div>
                    <div style="font-size: 9pt; display: flex; justify-content: space-between;">
                        <span>Discount (${sale.discount_percent}%):</span>
                        <span style="font-weight: bold;">${((sale.subtotal + sale.tax_amount) * (sale.discount_percent / 100)).toFixed(2)} PKR</span>
                    </div>
                    <hr style="border-top: 1px solid black;">
                    <div style="font-size: 11pt; font-weight: bold; display: flex; justify-content: space-between;">
                        <span>GRAND TOTAL:</span>
                        <span>${sale.total.toFixed(2)} PKR</span>
                    </div>
                    
                    <div class="invoice-footer">
                        Thank You!
                        <br>
                        (Backend: Supabase - Make sure your tables exist!)
                    </div>
                </div>
            `;

            document.getElementById('print-area').innerHTML = printContent;
            window.print();
            document.getElementById('print-area').innerHTML = '';
        }

        function showReturnModal() {
            document.getElementById('return-invoice-id').value = '';
            document.getElementById('return-details-area').innerHTML = '';
            const returnModal = new bootstrap.Modal(document.getElementById('returnModal'));
            returnModal.show();
        }

        function loadSaleForReturn() {
            const invoiceId = parseInt(document.getElementById('return-invoice-id').value);
            const sale = sales.find(s => s.invoice === invoiceId && s.type === 'Sale');
            const detailsArea = document.getElementById('return-details-area');

            detailsArea.innerHTML = '';

            if (!sale) {
                detailsArea.innerHTML = `<div class="alert alert-danger mt-3">Invoice ID ${invoiceId} not found or is a refund/return transaction.</div>`;
                return;
            }

            const items = typeof sale.items === 'string' ? JSON.parse(sale.items) : sale.items;
            let html = `
                <div class="alert alert-success mt-3">
                    <strong>Original Sale Details (Invoice ${sale.invoice})</strong>
                    <p>Date: ${new Date(sale.full_date).toLocaleDateString()}</p>
                    <p>Total Paid: ${sale.total.toFixed(2)} PKR</p>
                    <p>Customer: ${sale.customer_name || 'N/A'}</p>
                </div>
                <h6 class="text-danger">Select Items to Return (Max Qty: Original Sale Qty)</h6>
                <table class="table table-sm table-striped">
                    <thead><tr><th>Item</th><th>Max Qty</th><th>Return Qty</th></tr></thead>
                    <tbody>
            `;

            items.forEach((item, index) => {
                const itemEffectivePrice = item.line_total / item.qty;
                html += `
                    <tr>
                        <td>${item.name} (${item.batch})</td>
                        <td>${item.qty}</td>
                        <td>
                            <input type="number" id="return-qty-${index}" min="0" max="${item.qty}" value="0"
                                class="form-control form-control-sm return-qty-input" style="width: 60px;"
                                data-price="${itemEffectivePrice}" data-cost="${item.cost_price}" data-id="${item.id}" data-batch="${item.batch}" data-max="${item.qty}">
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                <h5 class="text-danger mt-3">Refund Amount: <span id="estimated-refund">0.00</span> PKR</h5>
                <button class="btn btn-danger w-100" onclick="processReturn(${sale.invoice})">Process Refund</button>
            `;

            detailsArea.innerHTML = html;

            document.querySelectorAll('.return-qty-input').forEach(input => {
                input.addEventListener('input', calculateEstimatedRefund);
            });
        }

        function calculateEstimatedRefund() {
            let estimatedRefund = 0;
            document.querySelectorAll('.return-qty-input').forEach(input => {
                const qty = parseInt(input.value) || 0;
                const price = parseFloat(input.dataset.price);
                estimatedRefund += qty * price;
            });
            document.getElementById('estimated-refund').textContent = estimatedRefund.toFixed(2);
        }

        async function processReturn(originalInvoiceId) {
            const sale = sales.find(s => s.invoice === originalInvoiceId && s.type === 'Sale');
            if (!sale) return alert("Original sale not found.");

            let refundItems = [];
            let refundAmount = 0;
            let totalRefundCost = 0;
            let inventoryUpdates = [];

            const originalSaleItems = typeof sale.items === 'string' ? JSON.parse(sale.items) : sale.items;

            document.querySelectorAll('.return-qty-input').forEach(input => {
                const qty = parseInt(input.value) || 0;

                if (qty > 0) {
                    const price = parseFloat(input.dataset.price);
                    const cost = parseFloat(input.dataset.cost);
                    const id = parseInt(input.dataset.id);
                    const batch = input.dataset.batch;

                    const originalItem = originalSaleItems.find(item => item.id === id && item.batch === batch);
                    if (!originalItem) return;

                    refundItems.push({
                        id: id,
                        name: originalItem.name,
                        batch: batch,
                        qty: qty,
                        sell_price: originalItem.sell_price,
                        cost_price: cost,
                        line_total: qty * price
                    });

                    refundAmount += qty * price;
                    totalRefundCost += qty * cost;

                    const inventoryItem = inventory.find(i => i.id === id && i.batch === batch);
                    if (inventoryItem) {
                        inventoryItem.stock += qty;
                        inventoryUpdates.push({ id: inventoryItem.id, stock: inventoryItem.stock });
                    }
                }
            });

            if (refundItems.length === 0) return alert("No items selected for refund.");
            if (!confirm(`Are you sure you want to process a refund of ${refundAmount.toFixed(2)} PKR?`)) return;

            const refundInvoiceId = sales.length > 0 ? Math.max(...sales.map(s => s.invoice)) + 1 : 1001;
            const fullDate = new Date();
            const refundDate = fullDate.toISOString().split('T')[0];

            const newRefund = {
                invoice: refundInvoiceId,
                date: refundDate,
                full_date: fullDate.toISOString(),
                total: -refundAmount,
                subtotal: -refundAmount,
                tax_percent: 0,
                tax_amount: 0,
                discount_percent: 0,
                total_cost: -totalRefundCost,
                profit: refundAmount - totalRefundCost,
                payment_method: 'Refund',
                customer_name: sale.customer_name || 'N/A',
                customer_phone: sale.customer_phone || 'N/A',
                items: JSON.stringify(refundItems.map(item => ({ ...item, line_total: -item.line_total }))),
                type: 'Refund',
                original_invoice: originalInvoiceId
            };

            const { data: refundData, error: refundError } = await supabaseClient.from(T_SALES).insert(newRefund).select();

            if (refundError) {
                console.error('Refund insert error:', refundError);
                alert("Error recording refund. Transaction failed.");
                return;
            }

            // Update inventory for returns
            try {
                for (const u of inventoryUpdates) {
                    const { error } = await supabaseClient.from(T_INVENTORY).update({ stock: u.stock }).eq('id', u.id);
                    if (error) console.error('Inventory return update error for', u.id, error);
                }
            } catch (err) {
                console.error('Critical inventory return error:', err);
            }

            sales.push(refundData[0]);
            renderInventory();
            renderDashboard();

            alert(`Refund processed. Refund Invoice ID: ${refundInvoiceId}`);
        }

        // ---- Reports / Purchases / Expenses basic renderers ----
        function renderReports(tab) {
            const reportContent = document.getElementById('report-content');
            if (!reportContent) return;
            reportContent.innerHTML = `<p class="text-muted">Report: ${tab} (Basic demo)</p>`;
        }

        function applyReportFilter() {
            const start = document.getElementById('report-start-date').value;
            const end = document.getElementById('report-end-date').value;
            currentFilterStartDate = start; currentFilterEndDate = end;
            renderReports('sales-report');
        }

        function renderPurchaseHistory() {
            const tbody = document.getElementById('purchase-table')?.querySelector('tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            purchases.forEach(p => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${p.date}</td><td>${p.invoice_no || 'N/A'}</td><td>${p.supplier || 'N/A'}</td><td>${(p.total || 0).toFixed(2)}</td><td>-</td>`;
            });
        }

        function renderExpenseHistory() {
            const tbody = document.getElementById('expense-table')?.querySelector('tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            expenses.forEach(e => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${e.date}</td><td>${e.category}</td><td>${(e.amount || 0).toFixed(2)}</td><td>${e.description}</td><td>-</td>`;
            });
        }

        // --- attach form handlers for purchases & expenses (simple inserts) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Tab buttons
            document.querySelectorAll('.tabs button').forEach(btn => {
                btn.addEventListener('click', () => {
                    showScreen(btn.dataset.target);
                });
            });

            // Add supplier
            const supplierForm = document.getElementById('add-supplier-form');
            if (supplierForm) supplierForm.addEventListener('submit', handleAddSupplier);

            // Add product
            const productForm = document.getElementById('add-product-form');
            if (productForm) productForm.addEventListener('submit', handleAddProduct);

            // Purchase form (basic)
            const purchaseForm = document.getElementById('add-purchase-form');
            if (purchaseForm) {
                purchaseForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const supplier = document.getElementById('purchase-supplier').value;
                    const date = document.getElementById('purchase-date').value;
                    const invoice_no = document.getElementById('purchase-invoice-no').value;
                    const total = parseFloat(document.getElementById('purchase-total').value) || 0;
                    const newPurchase = { supplier, date, invoice_no, total };
                    const { data, error } = await supabaseClient.from(T_PURCHASES).insert(newPurchase).select();
                    if (error) { console.error('Purchase insert error', error); alert('Error saving purchase'); return; }
                    purchases.push(data[0]);
                    renderPurchaseHistory();
                    purchaseForm.reset();
                    alert('Purchase recorded.');
                });
            }

            // Expense form
            const expenseForm = document.getElementById('add-expense-form');
            if (expenseForm) {
                expenseForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const category = document.getElementById('expense-category').value;
                    const date = document.getElementById('expense-date').value;
                    const amount = parseFloat(document.getElementById('expense-amount').value) || 0;
                    const description = document.getElementById('expense-description').value || '';
                    const { data, error } = await supabaseClient.from(T_EXPENSES).insert({ category, date, amount, description }).select();
                    if (error) { console.error('Expense insert error', error); alert('Error saving expense'); return; }
                    expenses.push(data[0]);
                    renderExpenseHistory();
                    expenseForm.reset();
                    alert('Expense recorded.');
                });
            }

            // CSV input is already wired in HTML (onchange)
            loadData();
        });
    </script>
</body>
</html>